It i<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Journey Together - Travel & Relationship Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 25%, #fecfef 75%, #ff9a9e 100%);
            height: 100vh; 
            overflow-y: auto; 
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 182, 193, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 192, 203, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 218, 224, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .app-container { display: flex; flex-direction: column; height: 100vh; }
        .app-header { 
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 25%, #ffa8a8 50%, #ff8e8e 75%, #ff6b6b 100%); 
            color: white; 
            padding: 1rem 2rem; 
            box-shadow: 0 4px 20px rgba(255, 107, 107, 0.3);
            position: relative;
            overflow: visible;
        }

        .app-header::before {
            content: '💕';
            position: absolute;
            top: 15px;
            right: 30px;
            font-size: 1.5rem;
            opacity: 0.2;
            animation: float 3s ease-in-out infinite;
            z-index: 1;
        }

        .app-header::after {
            content: '💖';
            position: absolute;
            bottom: 15px;
            left: 40px;
            font-size: 1.2rem;
            opacity: 0.2;
            animation: float 3s ease-in-out infinite reverse;
            z-index: 1;
        }
        .header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            max-width: 1400px; 
            margin: 0 auto; 
            position: relative;
            z-index: 10;
            padding: 0.5rem 0;
        }
        .app-title { 
            font-size: 1.8rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem;
            position: relative;
            z-index: 10;
        }
        .main-content { display: flex; height: calc(100vh - 80px); gap: 1rem; padding: 1rem; max-width: 1400px; margin: 0 auto; width: calc(100% - 2rem); }
        .stats-sidebar { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2); 
            padding: 1.5rem; 
            overflow-y: auto; 
            width: 300px; 
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .stats-section h3 { color: #2c3e50; font-size: 0.95rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        .stat-card { 
            background: linear-gradient(135deg, #fff5f5, #ffe6e6); 
            border-radius: 12px; 
            padding: 0.75rem; 
            text-align: center; 
            border: 1px solid rgba(255, 107, 107, 0.2);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 107, 107, 0.2);
        }

        .stat-value { 
            font-size: 1.3rem; 
            font-weight: 700; 
            color: #ff6b6b; 
            margin-bottom: 0.25rem;
            text-shadow: 0 1px 2px rgba(255, 107, 107, 0.3);
        }
        .stat-label { 
            font-size: 0.7rem; 
            color: #8b5a5a; 
            font-weight: 500; 
        }
        .map-container { 
            position: relative; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2); 
            flex: 1; 
            min-height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .map { width: 100%; height: 100%; min-height: 500px; }
        .map-controls { position: absolute; top: 1rem; right: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1000; }
        .route-controls { position: absolute; bottom: 1rem; left: 1rem; display: flex; flex-direction: column; gap: 0.5rem; z-index: 1000; }
        .btn { 
            padding: 0.75rem 1.5rem; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 0.9rem; 
            font-weight: 500; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.2);
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3); 
        }
        .btn-primary { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: white; }
        .btn-secondary { background: linear-gradient(135deg, #ff8a8a, #ff6b6b); color: white; }
        .btn-success { background: linear-gradient(135deg, #ff9ff3, #f368e0); color: white; }
        .btn-warning { background: linear-gradient(135deg, #feca57, #ff9ff3); color: white; }
        .btn-info { background: linear-gradient(135deg, #74b9ff, #a29bfe); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff7675, #e84393); color: white; }
        .timeline-panel { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 16px; 
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2); 
            margin: 1rem auto; 
            max-width: 1400px; 
            width: calc(100% - 2rem);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .timeline-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem 1.5rem; 
            border-bottom: 1px solid rgba(255, 107, 107, 0.2); 
            background: linear-gradient(135deg, #fff5f5, #ffe6e6);
            border-radius: 16px 16px 0 0;
        }
        .timeline-content { padding: 1rem 1.5rem; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid #bdc3c7; }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: #2c3e50; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #bdc3c7; border-radius: 8px; font-size: 0.9rem; }
        .form-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #bdc3c7; }
        .search-results { max-height: 200px; overflow-y: auto; border: 1px solid #bdc3c7; border-radius: 8px; background: white; position: absolute; width: 100%; z-index: 1000; }
        .search-result { padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result:hover { background: #f8f9fa; }
        .home-marker { background: #e74c3c !important; border: 3px solid white !important; box-shadow: 0 0 0 3px #e74c3c !important; }
        .home-marker-2 { background: #3498db !important; border: 3px solid white !important; box-shadow: 0 0 0 3px #3498db !important; }
        .route-line { filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3)); }
        .route-label { background: transparent; padding: 0; font-size: 0.8rem; font-weight: normal; color: #2c3e50; text-shadow: 1px 1px 2px rgba(255,255,255,0.8); }
        .plane-marker { background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .tabs { display: flex; border-bottom: 2px solid #e9ecef; margin-bottom: 1rem; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab.active { border-bottom-color: #e74c3c; background: #f8f9fa; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .route-item { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .route-title { font-weight: 600; color: #2c3e50; }
        .route-actions { display: flex; gap: 0.5rem; }
        .route-details { color: #6c757d; font-size: 0.9rem; }
        .route-stats { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .route-stat { background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .trip-item { background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .trip-title { font-weight: 600; color: #2c3e50; }
        .trip-actions { display: flex; gap: 0.5rem; }
        .trip-details { color: #6c757d; font-size: 0.9rem; }
        .trip-stats { display: flex; gap: 1rem; margin-top: 0.5rem; }
        .trip-stat { background: #f8f9fa; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); color: white; } .date-range { display: flex; gap: 1rem; } .date-range .form-group { flex: 1; } .timeline-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; } .timeline-filters select, .timeline-filters input { padding: 0.5rem; border: 1px solid #bdc3c7; border-radius: 6px; font-size: 0.9rem; } .timeline-year-nav { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; } .year-btn { padding: 0.4rem 0.8rem; border: 1px solid #bdc3c7; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; } .year-btn:hover { background: #f8f9fa; border-color: #e74c3c; } .year-btn.active { background: #e74c3c; color: white; border-color: #e74c3c; } .tl-item { transition: all 0.2s ease; } .tl-item:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12) !important; } .tl-head:hover { background: #f8f9fa; } .tl-details { border-top: 1px solid #e9ecef; margin-top: 0.5rem; } @media (max-width: 768px) { .date-range { flex-direction: column; } .timeline-filters { flex-direction: column; align-items: stretch; } .timeline-year-nav { justify-content: center; } }
        @media (max-width: 768px) { .main-content { flex-direction: column; } .stats-sidebar { width: 100%; } }
        
        /* CodyHouse Style Horizontal Timeline */
        .cd-h-timeline {
            position: relative;
            background: #ffffff;
            border-radius: 12px;
            margin: 1rem 0;
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .cd-h-timeline__container {
            position: relative;
            height: 100px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            overflow: visible;
        }
        
        /* Timeline Navigation Buttons */
        .cd-h-timeline__navigation {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
            color: white;
            font-size: 1.4rem;
            font-weight: bold;
            border: 3px solid white;
            text-decoration: none;
        }
        
        .cd-h-timeline__navigation:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
        }
        
        .cd-h-timeline__navigation--prev {
            left: 0.5rem;
        }
        
        .cd-h-timeline__navigation--next {
            right: 0.5rem;
        }
        
        .cd-h-timeline__navigation--inactive {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            background: #bdc3c7;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        
        /* CodyHouse Timeline Dates Section */
        .cd-h-timeline__dates {
            position: relative;
            height: 100%;
            margin: 0 40px;
            overflow: hidden;
        }
        
        .cd-h-timeline__dates::after,
        .cd-h-timeline__dates::before {
            content: '';
            position: absolute;
            z-index: 2;
            top: 0;
            height: 100%;
            width: 20px;
        }
        
        .cd-h-timeline__dates::before {
            left: 0;
            background: linear-gradient(to right, #ffffff, rgba(255,255,255,0));
        }
        
        .cd-h-timeline__dates::after {
            right: 0;
            background: linear-gradient(to left, #ffffff, rgba(255,255,255,0));
        }
        
        .cd-h-timeline__line {
            position: absolute;
            z-index: 1;
            left: 0;
            top: 49px;
            height: 3px;
            background: linear-gradient(90deg, #e74c3c 0%, #f39c12 30%, #3498db 60%, #27ae60 100%);
            border-radius: 2px;
            transition: transform 0.4s;
        }
        
        .cd-h-timeline__filling-line {
            position: absolute;
            z-index: 1;
            left: 0;
            top: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, #ff6b6b 0%, #fdcb6e 50%, #74b9ff 100%);
            transform: scaleX(0);
            transform-origin: left center;
            transition: transform 0.3s;
        }
        
        
        .cd-h-timeline__dates ol {
            position: relative;
            margin: 0;
            padding: 0;
            list-style: none;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 60px;
        }
        
        /* Year Labels */
        .cd-h-timeline__year-label {
            position: absolute;
            top: -25px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #7f8c8d;
            text-align: center;
            width: 60px;
            transform: translateX(-50%);
        }
        
        .cd-h-timeline__date {
            position: absolute;
            bottom: 0;
            z-index: 2;
            text-align: center;
            font-size: 0.8em;
            padding-bottom: 0.75em;
            color: #2c3e50;
            user-select: none;
            text-decoration: none;
            cursor: pointer;
        }
        
        .cd-h-timeline__date::after {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: -25px;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            border-width: 2px;
            border-style: solid;
            border-color: #e9ecef;
            background-color: #ffffff;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .cd-h-timeline__date:hover::after {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .cd-h-timeline__date--selected::after {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .cd-h-timeline__date--older-event::after {
            border-color: #e74c3c;
        }
        
        /* Year Labels */
        .cd-h-timeline__year-label {
            position: absolute;
            top: -35px;
            left: 0;
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #e9ecef;
            transform: translateX(-50%);
            z-index: 3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .timeline-emoji {
            font-size: 1.2rem;
            line-height: 1;
            display: block;
        }
        
        .timeline-date {
            font-size: 0.7rem;
            line-height: 1;
            display: block;
        }
        
        .cd-h-timeline__date:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateX(-50%) translateY(-8px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.25);
            background: linear-gradient(135deg, #ffffff 0%, #f0f2ff 100%);
        }
        
        .cd-h-timeline__date--selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            transform: translateX(-50%) translateY(-12px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
            font-size: 1rem;
        }
        
        .cd-h-timeline__date--selected:hover {
            transform: translateX(-50%) translateY(-16px);
            box-shadow: 0 16px 50px rgba(102, 126, 234, 0.5);
        }
        
        /* Enhanced Event Emoji Indicators */
        .cd-h-timeline__date::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .cd-h-timeline__date--selected::before,
        .cd-h-timeline__date:hover::before {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        /* Event type specific styling for timeline dates */
        .cd-h-timeline__date.anniversary {
            border-color: #ff6b6b;
        }
        
        .cd-h-timeline__date.anniversary:hover {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe6e6 100%);
        }
        
        .cd-h-timeline__date.trip {
            border-color: #74b9ff;
        }
        
        .cd-h-timeline__date.trip:hover {
            border-color: #74b9ff;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }
        
        .cd-h-timeline__date.special-day {
            border-color: #fdcb6e;
        }
        
        .cd-h-timeline__date.special-day:hover {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #fffbf0 0%, #fff5e6 100%);
        }
        
        .cd-h-timeline__date.location {
            border-color: #00b894;
        }
        
        .cd-h-timeline__date.location:hover {
            border-color: #00b894;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fff0 100%);
        }
        
        /* Compact Events Display */
        .cd-h-timeline__events {
            position: relative;
            min-height: 200px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            margin-top: 1rem;
        }
        
        .cd-h-timeline__events ol {
            position: relative;
            margin: 0;
            padding: 1.5rem;
            list-style: none;
            height: 100%;
        }
        
        .cd-h-timeline__event {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s ease;
            z-index: 1;
            padding: 1.5rem;
            pointer-events: none;
        }
        
        .cd-h-timeline__event--selected {
            opacity: 1;
            transform: translateX(0);
            z-index: 2;
            pointer-events: auto;
        }
        
        .cd-h-timeline__event--enter-right,
        .cd-h-timeline__event--leave-right {
            animation: cd-enter-right 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .cd-h-timeline__event--enter-left,
        .cd-h-timeline__event--leave-left {
            animation: cd-enter-left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .cd-h-timeline__event--leave-right,
        .cd-h-timeline__event--leave-left {
            animation-direction: reverse;
        }
        
        @keyframes cd-enter-right {
            0% {
                opacity: 0;
                transform: translateX(50px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes cd-enter-left {
            0% {
                opacity: 0;
                transform: translateX(-50px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .cd-h-timeline__event-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .cd-h-timeline__event-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            border-radius: 0 3px 3px 0;
        }
        
        
        .cd-h-timeline__event-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 1rem 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            line-height: 1.2;
        }
        
        .cd-h-timeline__event-title::before {
            font-size: 1.8rem;
            opacity: 0.9;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .cd-h-timeline__event.anniversary .cd-h-timeline__event-title::before { content: '📅'; }
        .cd-h-timeline__event.trip .cd-h-timeline__event-title::before { content: '🧳'; }
        .cd-h-timeline__event.special-day .cd-h-timeline__event-title::before { content: '✨'; }
        .cd-h-timeline__event.location .cd-h-timeline__event-title::before { content: '🌍'; }
        
        .cd-h-timeline__event-date {
            font-size: 1rem;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .cd-h-timeline__event-date::before {
            content: '📅';
            font-size: 1.2rem;
            opacity: 0.8;
        }
        
        .cd-h-timeline__event-description {
            font-size: 1rem;
            line-height: 1.6;
            color: #495057;
            margin: 0;
            font-weight: 400;
        }
        
        /* Event Type Specific Styling */
        .cd-h-timeline__event.anniversary .cd-h-timeline__event-content::before {
            background: linear-gradient(180deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        .cd-h-timeline__event.trip .cd-h-timeline__event-content::before {
            background: linear-gradient(180deg, #74b9ff 0%, #0984e3 100%);
        }
        
        .cd-h-timeline__event.special-day .cd-h-timeline__event-content::before {
            background: linear-gradient(180deg, #fdcb6e 0%, #e17055 100%);
        }
        
        .cd-h-timeline__event.location .cd-h-timeline__event-content::before {
            background: linear-gradient(180deg, #00b894 0%, #00a085 100%);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .cd-h-timeline__container {
                padding: 0 1rem;
            }
            
            .cd-h-timeline__navigation {
                width: 35px;
                height: 35px;
            }
            
            .cd-h-timeline__navigation--prev {
                left: 0.5rem;
            }
            
            .cd-h-timeline__navigation--next {
                right: 0.5rem;
            }
            
            .cd-h-timeline__event-content {
                padding: 1.5rem;
            }
            
            .cd-h-timeline__event-title {
                font-size: 1.5rem;
            }
            
            .cd-h-timeline__date {
                font-size: 0.8rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* Horizontal Timeline Bar Styles */
        .timeline-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .timeline-header h3 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .timeline-controls {
            display: flex;
            gap: 0.5rem;
        }

        .timeline-container {
            position: relative;
        }

        .timeline-bar {
            position: relative;
            height: 120px;
            margin: 2rem 0;
            overflow-x: auto;
            overflow-y: visible;
        }

        .timeline-line {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #74b9ff, #00b894);
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timeline-events {
            position: relative;
            height: 100%;
            min-width: 100%;
        }

        .timeline-event {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .timeline-event:hover {
            transform: translateY(-50%) scale(1.1);
            z-index: 20;
        }

        .timeline-event-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
            margin: 0 auto;
        }

        .timeline-event.anniversary .timeline-event-dot {
            background: linear-gradient(135deg, #ff6b6b, #ff8a8a);
        }

        .timeline-event.trip .timeline-event-dot {
            background: linear-gradient(135deg, #74b9ff, #a29bfe);
        }

        .timeline-event.special-day .timeline-event-dot {
            background: linear-gradient(135deg, #feca57, #ff9ff3);
        }

        .timeline-event.location .timeline-event-dot {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .timeline-event-label {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            white-space: nowrap;
        }

        .timeline-event-date {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #7f8c8d;
            font-weight: 500;
        }

        .timeline-event-actions {
            position: absolute;
            top: -80px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .timeline-event:hover .timeline-event-actions {
            opacity: 1;
        }

        .timeline-event-actions button {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .timeline-event-actions .edit-btn {
            background: #3498db;
            color: white;
        }

        .timeline-event-actions .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .timeline-event-actions button:hover {
            transform: scale(1.1);
        }

        .timeline-details {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
            min-height: 120px;
            max-height: 400px;
            overflow-y: auto;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .timeline-details.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #7f8c8d;
            font-style: italic;
            min-height: 80px;
            opacity: 0.6;
        }

        .timeline-details:not(.empty) {
            opacity: 1;
            transform: translateY(0);
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timeline-event.selected {
            transform: translateY(-50%) scale(1.2);
            z-index: 30;
        }

        .timeline-event.selected .timeline-event-dot {
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.6);
            animation: pulse 2s infinite;
        }

        .event-details {
            text-align: center;
            padding: 1rem;
            min-height: 100px;
        }

        .event-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .event-emoji {
            font-size: 1.5rem;
            animation: heartbeat 2s ease-in-out infinite;
            display: inline-block;
            line-height: 1;
        }

        .event-meta {
            margin-bottom: 1.5rem;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .event-meta p {
            margin: 0.5rem 0;
            color: #495057;
            font-size: 1rem;
        }

        .event-type {
            text-transform: capitalize;
            font-weight: 600;
            color: #e74c3c;
            background: #fff5f5;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #ffcccb;
        }

        .event-description {
            margin-bottom: 2rem;
            color: #2c3e50;
            line-height: 1.8;
            font-size: 1.1rem;
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .event-description p {
            margin: 0;
            line-height: 1.6;
        }

        .event-description p * {
            vertical-align: middle;
            display: inline;
        }

        .event-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .event-actions .btn {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .event-actions .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        @keyframes heartbeat {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* vis.js Timeline Custom Styling */
        .vis-timeline {
            background-color: white !important;
            border: 1px solid #e9ecef !important;
            border-radius: 8px !important;
        }

        .vis-timeline .vis-panel {
            background-color: white !important;
        }

        .vis-timeline .vis-background {
            background-color: white !important;
        }

        .vis-timeline .vis-grid {
            background-color: white !important;
        }

        .vis-timeline .vis-foreground {
            background-color: white !important;
        }

        .vis-timeline .vis-labelset {
            background-color: white !important;
        }

        .vis-timeline .vis-time-axis {
            background-color: white !important;
        }

        .vis-timeline .vis-itemset {
            background-color: white !important;
        }

        .vis-timeline .vis-item {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid #dee2e6 !important;
            border-radius: 6px !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }

        .vis-timeline .vis-item:hover {
            background-color: white !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }

        .vis-timeline .vis-item.vis-selected {
            background-color: #f8f9fa !important;
            border-color: #007bff !important;
        }
        
        .timeline-start-marker {
            position: absolute;
            left: 2rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 3;
        }
        
        .timeline-start-label {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-100%);
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .timeline-event-dot {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        .timeline-event-dot:hover {
            transform: translateY(-50%) scale(1.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .timeline-event-dot.anniversary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .timeline-event-dot.trip {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }
        
        .timeline-event-dot.special-day {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
        }
        
        .timeline-event-dot.location {
            background: linear-gradient(135deg, #00b894, #00a085);
        }
        
        .timeline-event-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            color: #2c3e50;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            max-width: 200px;
            text-align: center;
        }
        
        .timeline-event-dot:hover .timeline-event-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }
        
        .timeline-event-dot.expanded {
            transform: translateY(-50%) scale(1.5);
            z-index: 5;
        }
        
        .timeline-event-details {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            min-width: 300px;
            max-width: 400px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            border: 2px solid #e74c3c;
        }
        
        .timeline-event-details.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }
        
        .event-detail-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .event-detail-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .event-detail-title {
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .event-detail-date {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
        
        .event-detail-content {
            color: #2c3e50;
            line-height: 1.5;
        }
        
        .close-detail {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #95a5a6;
            cursor: pointer;
            padding: 0.25rem;
        }
        
        .close-detail:hover {
            color: #e74c3c;
        }
        
        .timeline-year-label {
            position: absolute;
            top: 10px;
            font-size: 1rem;
            font-weight: 700;
            color: #2c3e50;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            border: 2px solid #e74c3c;
            z-index: 1;
            transform: translateX(-50%);
        }
        
        .event-emoji {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            z-index: 3;
            pointer-events: none;
        }
        
        /* Trip Separation Layout */
        .trips-split-container {
            display: flex;
            gap: 2rem;
            margin: 1rem 0;
        }
        
        .trip-column {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .trip-column.christine {
            border-left: 4px solid #27ae60;
        }
        
        .trip-column.philipp {
            border-left: 4px solid #f39c12;
        }
        
        .trip-column.both {
            border-left: 4px solid #e74c3c;
        }
        
        .column-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .column-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
        }
        
        .column-avatar.christine {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .column-avatar.philipp {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }
        
        .column-avatar.both {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .column-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }
        
        .trip-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 3px solid #bdc3c7;
            transition: all 0.2s ease;
        }
        
        .trip-item:hover {
            background: #ecf0f1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .trip-item.christine {
            border-left-color: #27ae60;
        }
        
        .trip-item.philipp {
            border-left-color: #f39c12;
        }
        
        .trip-item.both {
            border-left-color: #e74c3c;
        }
        
        .trip-item-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .trip-title {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .trip-date {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin: 0;
        }
        
        .trip-details {
            font-size: 0.9rem;
            color: #34495e;
            line-height: 1.4;
        }

        /* Modern Timeline Design (Fallback) */
        .timeline-container {
            position: relative;
            padding: 2rem 0;
        }
        
        .timeline-year-section {
            margin-bottom: 3rem;
            position: relative;
        }
        
        .timeline-year-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
            z-index: 10;
        }
        
        .timeline-year-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .year-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .timeline-events {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline-events::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, #e74c3c, #f39c12, #3498db);
            border-radius: 2px;
        }
        
        .timeline-event {
            position: relative;
            margin-bottom: 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 4px solid transparent;
        }
        
        .timeline-event:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .timeline-event::before {
            content: '';
            position: absolute;
            left: -2.5rem;
            top: 1.5rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 0 3px currentColor;
            z-index: 2;
        }
        
        .timeline-event.anniversary {
            border-left-color: #e74c3c;
            color: #e74c3c;
        }
        
        .timeline-event.trip {
            border-left-color: #3498db;
            color: #3498db;
        }
        
        .timeline-event.special-day {
            border-left-color: #f39c12;
            color: #f39c12;
        }
        
        .timeline-event.location {
            border-left-color: #27ae60;
            color: #27ae60;
        }
        
        .timeline-event-header {
            padding: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background-color 0.2s ease;
        }
        
        .timeline-event-header:hover {
            background: #f8f9fa;
        }
        
        .event-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        
        .timeline-event.anniversary .event-icon {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .timeline-event.trip .event-icon {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
        }
        
        .timeline-event.special-day .event-icon {
            background: linear-gradient(135deg, #fdcb6e, #e17055);
            color: white;
        }
        
        .timeline-event.location .event-icon {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
        }
        
        .event-content {
            flex: 1;
        }
        
        .event-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0 0 0.25rem 0;
        }
        
        .event-date {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .event-subtitle {
            font-size: 0.85rem;
            color: #95a5a6;
            margin-top: 0.25rem;
        }
        
        .expand-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #7f8c8d;
            transition: all 0.2s ease;
        }
        
        .timeline-event.expanded .expand-icon {
            background: currentColor;
            color: white;
            transform: rotate(180deg);
        }
        
        .timeline-event-details {
            padding: 0 1.5rem 1.5rem 1.5rem;
            color: #2c3e50;
            line-height: 1.6;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .timeline-event.expanded .timeline-event-details {
            max-height: 500px;
            padding-top: 1rem;
        }
        
        /* Timeline Animations */
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3) translateY(-20px); }
            50% { opacity: 1; transform: scale(1.05) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        
        .timeline-year-header { animation: fadeIn 0.6s ease; }
        .timeline-event { animation: bounceIn 0.5s ease; }
        .timeline-event:nth-child(even) { animation-delay: 0.1s; }
        .timeline-event:nth-child(odd) { animation-delay: 0.2s; }
        
        /* Enhanced Timeline Styling */
        .timeline-content { max-height: 600px; overflow-y: auto; }
        .timeline-content::-webkit-scrollbar { width: 6px; }
        .timeline-content::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
        .timeline-content::-webkit-scrollbar-thumb { background: #e74c3c; border-radius: 3px; }
        .timeline-content::-webkit-scrollbar-thumb:hover { background: #c0392b; }
        
        /* City Autocomplete Styling */
        .search-results { 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            max-height: 200px; 
            overflow-y: auto; 
            z-index: 1000;
        }
        
        .search-result-item:hover { 
            background-color: #f8f9fa !important; 
        }
        
        .form-group { 
            position: relative; 
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1 class="app-title"><i class="fas fa-heart"></i> Our Journey Together</h1>
                <div class="header-controls">
                    <button id="settingsBtn" class="btn btn-icon" title="Settings"><i class="fas fa-cog"></i></button>
                    <button id="exportBtn" class="btn btn-icon" title="Export Data"><i class="fas fa-download"></i></button>
                    <button id="testDateBtn" class="btn btn-icon" title="Test Date Calculation"><i class="fas fa-clock"></i></button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <aside class="stats-sidebar">
                <div class="sidebar-header">
                    <h2>Our Statistics</h2>
                </div>
                <div class="stats-content">
                    <section class="stats-section">
                        <h3><i class="fas fa-heart"></i> Relationship</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="yearsTogether">00</div>
                                <div class="stat-label">Years</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="monthsTogether">00</div>
                                <div class="stat-label">Months</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="daysTogether">00</div>
                                <div class="stat-label">Days</div>
                            </div>
                        </div>
                    </section>
                    <section class="stats-section">
                        <h3><i class="fas fa-map-marked-alt"></i> Travel</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="citiesVisited">0</div>
                                <div class="stat-label">Cities</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="countriesVisited">0</div>
                                <div class="stat-label">Countries</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="tripsCompleted">0</div>
                                <div class="stat-label">Trips</div>
                            </div>
                        </div>
                    </section>
                    
                    <section class="stats-section">
                        <h3><i class="fas fa-calendar-heart"></i> Events & Memories</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="customEvents">0</div>
                                <div class="stat-label">Custom Events</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalEvents">0</div>
                                <div class="stat-label">Total Events</div>
                            </div>
                        </div>
                    </section>
                    <section class="stats-section">
                        <h3><i class="fas fa-route"></i> Routes</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalRoutes">0</div>
                                <div class="stat-label">Total Routes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalDistance">0</div>
                                <div class="stat-label">Total Miles</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1rem 0 0.5rem 0; color: #e74c3c;">Christine's Travel</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="christineRoutes">0</div>
                                <div class="stat-label">Routes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="christineDistance">0</div>
                                <div class="stat-label">Miles</div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 1rem 0 0.5rem 0; color: #3498db;">Philipp's Travel</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="philippRoutes">0</div>
                                <div class="stat-label">Routes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="philippDistance">0</div>
                                <div class="stat-label">Miles</div>
                            </div>
                        </div>
                    </section>
                </div>
            </aside>

            <section class="map-container">
                <div id="map" class="map"></div>
                <div class="map-controls">
                    <button id="addLocationBtn" class="btn btn-primary"><i class="fas fa-plus"></i> Add Location</button>
                    <button id="centerMapBtn" class="btn btn-secondary"><i class="fas fa-crosshairs"></i> Center</button>
                </div>
                <div class="route-controls">
                    <button id="setHome1Btn" class="btn btn-success"><i class="fas fa-home"></i> Christine</button>
                    <button id="setHome2Btn" class="btn btn-warning"><i class="fas fa-home"></i> Philipp</button>
                    <button id="addRouteBtn" class="btn btn-primary"><i class="fas fa-route"></i> Add Trip</button>
                    <button id="clearRoutesBtn" class="btn btn-secondary"><i class="fas fa-trash"></i> Clear Routes</button>
                </div>
            </section>
        </main>

        <section class="timeline-panel">
            <div class="timeline-header">
                <h2>Our Journey</h2>
                <div class="tabs">
                    <div class="tab active" data-tab="timeline">Timeline</div>
                    <div class="tab" data-tab="routes">Routes</div>
                    <div class="tab" data-tab="trips">Trips</div>
                </div>
            </div>
            <div class="timeline-content" id="timelineContent">
                <div class="tab-content active" id="timeline-tab">
                    <div class="timeline-filters">
                        <select id="timelineTypeFilter">
                            <option value="all">All Events</option>
                            <option value="anniversary">Anniversaries</option>
                            <option value="trip">Trips</option>
                            <option value="special-day">Special Days</option>
                            <option value="location">Locations</option>
                        </select>
                        <input type="text" id="timelineSearch" placeholder="Search events...">
                        <button onclick="mapController.clearTimelineFilters()" class="btn btn-secondary btn-sm">Clear</button>
                        <button onclick="mapController.showAddEventModal()" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Add Event</button>
                        <button onclick="mapController.resetTimelineSettings()" class="btn btn-warning btn-sm"><i class="fas fa-refresh"></i> Reset Dates</button>
                        <button onclick="mapController.exportTimelineData()" class="btn btn-success btn-sm"><i class="fas fa-download"></i> Export</button>
                        <button onclick="mapController.importTimelineData()" class="btn btn-info btn-sm"><i class="fas fa-upload"></i> Import</button>
                    </div>
                    
        <!-- vis.js Interactive Timeline -->
        <section class="timeline-section">
            <div class="timeline-header">
                <h3><i class="fas fa-heart"></i> Our Journey Timeline</h3>
                <div class="timeline-controls">
                    <button onclick="mapController.showAddEventModal()" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> Add Event
                    </button>
                    <button onclick="mapController.resetTimelineSettings()" class="btn btn-warning btn-sm">
                        <i class="fas fa-refresh"></i> Reset Dates
                    </button>
                </div>
            </div>
            <div class="timeline-container">
                <div id="timeline" style="height: 200px; border: 1px solid #e9ecef; border-radius: 8px; background-color: white;"></div>
                <div class="timeline-details" id="timelineDetails">
                    <!-- Selected event details will be shown here -->
                </div>
            </div>
        </section>
                    
                    <div id="timelineEventsLegacy" class="timeline-content timeline-container" style="display: none;"></div>
                </div>
                <div class="tab-content" id="routes-tab">
                    <div id="routesList">
                        <p>No trips created yet. Click "Add Trip" to create your first trip!</p>
                    </div>
                </div>
                <div class="tab-content" id="trips-tab">
                    <div id="tripsList">
                        <p>No trips recorded yet. Add your first trip to get started!</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Add Location Modal -->
    <div id="addLocationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Location</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="locationForm">
                    <div class="form-group">
                        <label for="locationName">Location Name</label>
                        <input type="text" id="locationName" required>
                    </div>
                    <div class="form-group">
                        <label for="locationType">Type</label>
                        <select id="locationType" required>
                            <option value="visited">Visited</option>
                            <option value="wishlist">Wishlist</option>
                            <option value="booked">Booked Trip</option>
                            <option value="research">Research</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="visitDate">Visit Date</label>
                        <input type="date" id="visitDate">
                    </div>
                    <div class="form-group">
                        <label for="locationCountry">Country</label>
                        <input type="text" id="locationCountry" placeholder="Enter country name">
                    </div>
                    <div class="form-group">
                        <label for="locationNotes">Notes</label>
                        <textarea id="locationNotes" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="locationLat">Latitude</label>
                        <input type="number" id="locationLat" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="locationLng">Longitude</label>
                        <input type="number" id="locationLng" step="any" required>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Location</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Set Home Modal -->
    <div id="setHomeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="setHomeModalTitle">Set Home Location</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="setHomeForm">
                    <div class="form-group">
                        <label for="homeAddress">Address</label>
                        <input type="text" id="homeAddress" placeholder="Enter address or city name" required>
                        <div id="addressSearchResults" class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Set Home</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Event</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="eventForm">
                    <div class="form-group">
                        <label for="eventType">Event Type</label>
                        <select id="eventType" required>
                            <option value="anniversary">📅 Anniversary</option>
                            <option value="special-day">✨ Special Day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="eventTitle">Event Title</label>
                        <input type="text" id="eventTitle" placeholder="e.g., Our First Date" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDate">Event Date</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label for="eventDetails">Event Details (optional)</label>
                        <textarea id="eventDetails" placeholder="Describe this special moment..." rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="eventPhoto">Event Photo (optional)</label>
                        <input type="file" id="eventPhoto" accept="image/*">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Route Modal -->
    <div id="addRouteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Trip</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="routeForm">
                    <div class="form-group">
                        <label for="routeName">Trip Name</label>
                        <input type="text" id="routeName" placeholder="e.g., New York to Paris" required>
                    </div>
                    <div class="form-group">
                        <label for="traveler">Who was traveling?</label>
                        <select id="traveler" required>
                            <option value="both">Both Christine and Philipp</option>
                            <option value="christine">Christine only</option>
                            <option value="philipp">Philipp only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="christineStartCity">Christine's Starting City</label>
                        <input type="text" id="christineStartCity" placeholder="Enter Christine's starting city" required autocomplete="off">
                        <div id="christineStartCityResults" class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="philippStartCity">Philipp's Starting City</label>
                        <input type="text" id="philippStartCity" placeholder="Enter Philipp's starting city" required autocomplete="off">
                        <div id="philippStartCityResults" class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="toCity">Destination City</label>
                        <input type="text" id="toCity" placeholder="Enter destination city" required autocomplete="off">
                        <div id="toCityResults" class="search-results" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <div class="date-range"><div class="form-group"><label for="routeStartDate">Travel Start Date</label><input type="date" id="routeStartDate"></div><div class="form-group"><label for="routeEndDate">Travel End Date</label><input type="date" id="routeEndDate"></div></div>
                    </div>
                    <div class="form-group">
                        <label for="routeNotes">Notes</label>
                        <textarea id="routeNotes" rows="3" placeholder="Add any notes about this route..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Route</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Trip Modal -->
    <div id="addTripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Trip</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="tripForm">
                    <div class="form-group">
                        <label for="tripName">Trip Name</label>
                        <input type="text" id="tripName" placeholder="e.g., Summer Europe Adventure" required>
                    </div>
                    <div class="form-group">
                        <label for="tripStartDate">Start Date</label>
                        <input type="date" id="tripStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="tripEndDate">End Date</label>
                        <input type="date" id="tripEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="tripCities">Cities Visited (comma-separated)</label>
                        <input type="text" id="tripCities" placeholder="e.g., Paris, London, Rome" required>
                    </div>
                    <div class="form-group">
                        <label for="tripCountries">Countries Visited (comma-separated)</label>
                        <input type="text" id="tripCountries" placeholder="e.g., France, United Kingdom, Italy" required>
                    </div>
                    <div class="form-group">
                        <label for="tripNotes">Notes</label>
                        <textarea id="tripNotes" rows="3" placeholder="Add any notes about this trip..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary modal-close">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Trip</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@7.7.3/styles/vis-timeline-graph2d.css" rel="stylesheet" type="text/css" />
    <script>
        // Global variables
        let map, dataManager, mapController;
        let home1Marker = null, home2Marker = null;
        let routeMode = false;
        let routePoints = [];
        let routeLines = [];
        let routes = [];

        // Helper function to format numbers with leading zeros
        function formatNumber(num) {
            return num.toString().padStart(2, '0');
        }

        // Data Manager
        class DataManager {
            constructor() {
                this.storageKey = 'travelRelationshipData';
                this.defaultData = {
                    settings: {
                        relationshipStartDate: '2025-04-14',
                        firstMeetingDate: '2025-02-13',
                        countriesGoal: 50
                    },
                    locations: [],
                    milestones: [],
                    photos: {},
                    homeLocations: {
                        home1: null,
                        home2: null
                    },
                    routes: [],
                    trips: [],
                    customEvents: []
                };
                this.data = this.loadData();
            }

            loadData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        return { ...this.defaultData, ...parsed };
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                }
                return this.defaultData;
            }

            saveData() {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }

            getSettings() {
                return this.data.settings;
            }

            updateSettings(newSettings) {
                this.data.settings = { ...this.data.settings, ...newSettings };
                return this.saveData();
            }

            getLocations() {
                return this.data.locations;
            }

            getLocationById(id) {
                return this.data.locations.find(loc => loc.id === id);
            }

            addLocation(location) {
                const newLocation = {
                    id: this.generateId(),
                    ...location,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.data.locations.push(newLocation);
                this.saveData();
                return newLocation;
            }

            updateLocation(id, updates) {
                const index = this.data.locations.findIndex(loc => loc.id === id);
                if (index !== -1) {
                    this.data.locations[index] = {
                        ...this.data.locations[index],
                        ...updates,
                        updatedAt: new Date().toISOString()
                    };
                    this.saveData();
                    return this.data.locations[index];
                }
                return null;
            }

            deleteLocation(id) {
                const index = this.data.locations.findIndex(loc => loc.id === id);
                if (index !== -1) {
                    this.data.locations.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            }

            getHomeLocations() {
                return this.data.homeLocations;
            }

            setHomeLocation(homeNumber, location) {
                this.data.homeLocations[`home${homeNumber}`] = location;
                this.saveData();
            }

            getRoutes() {
                return this.data.routes;
            }

            addRoute(route) {
                const newRoute = {
                    id: this.generateId(),
                    ...route,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.data.routes.push(newRoute);
                this.saveData();
                return newRoute;
            }

            updateRoute(id, updates) {
                const index = this.data.routes.findIndex(route => route.id === id);
                if (index !== -1) {
                    this.data.routes[index] = {
                        ...this.data.routes[index],
                        ...updates,
                        updatedAt: new Date().toISOString()
                    };
                    this.saveData();
                    return this.data.routes[index];
                }
                return null;
            }

            deleteRoute(id) {
                const index = this.data.routes.findIndex(route => route.id === id);
                if (index !== -1) {
                    this.data.routes.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            }

            getTrips() {
                return this.data.trips;
            }

            addTrip(trip) {
                const newTrip = {
                    id: this.generateId(),
                    ...trip,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                this.data.trips.push(newTrip);
                this.saveData();
                return newTrip;
            }

            updateTrip(id, updates) {
                const index = this.data.trips.findIndex(trip => trip.id === id);
                if (index !== -1) {
                    this.data.trips[index] = {
                        ...this.data.trips[index],
                        ...updates,
                        updatedAt: new Date().toISOString()
                    };
                    this.saveData();
                    return this.data.trips[index];
                }
                return null;
            }

            deleteTrip(id) {
                const index = this.data.trips.findIndex(trip => trip.id === id);
                if (index !== -1) {
                    this.data.trips.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            }

            async getStatistics() {
                const locations = this.getLocations();
                const routes = this.getRoutes();
                const trips = this.getTrips();
                const settings = this.getSettings();
                const visitedLocations = locations.filter(loc => loc.type === 'visited');
                const countries = [...new Set(visitedLocations.map(loc => loc.country || 'Unknown'))];
                
                const now = new Date();
                const relationshipStart = settings.relationshipStartDate ? new Date(settings.relationshipStartDate) : null;
                let yearsTogether = 0;
                let monthsTogether = 0;
                let daysTogether = 0;
                
                if (relationshipStart) {
                    // Use API-based date calculation method
                    try {
                        const result = await this.calculateTimeSince(relationshipStart);
                        yearsTogether = result.years;
                        monthsTogether = result.months;
                        daysTogether = result.days;
                    } catch (error) {
                        console.error('Date calculation error:', error);
                        // Fallback to simple calculation
                        const today = new Date('2025-10-03');
                        const start = new Date(relationshipStart);
                        let years = today.getFullYear() - start.getFullYear();
                        let months = today.getMonth() - start.getMonth();
                        let days = today.getDate() - start.getDate();
                        
                        if (days < 0) {
                            months--;
                            days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                        }
                        if (months < 0) {
                            years--;
                            months += 12;
                        }
                        
                        yearsTogether = years;
                        monthsTogether = months;
                        daysTogether = days;
                    }
                }

                // Calculate individual distance and route statistics
                let christineDistance = 0;
                let philippDistance = 0;
                let christineRoutes = 0;
                let philippRoutes = 0;
                
                routes.forEach(route => {
                    if (route.distance && route.distance > 0) {
                        if (route.traveler === 'christine') {
                            christineDistance += route.distance;
                            christineRoutes++;
                        } else if (route.traveler === 'philipp') {
                            philippDistance += route.distance;
                            philippRoutes++;
                        }
                    }
                });
                
                const totalDistance = christineDistance + philippDistance;
                const totalRoutes = christineRoutes + philippRoutes;
                const avgDistance = totalRoutes > 0 ? Math.round(totalDistance / totalRoutes) : 0;

                // Calculate trip statistics
                let totalCities = 0;
                let totalCountries = 0;
                trips.forEach(trip => {
                    if (trip.cities) {
                        totalCities += trip.cities.split(',').length;
                    }
                    if (trip.countries) {
                        totalCountries += trip.countries.split(',').length;
                    }
                });
                
                const customEvents = this.getCustomEvents();
                
                return {
                    relationship: { yearsTogether, monthsTogether, daysTogether },
                    travel: { 
                        citiesVisited: Math.max(visitedLocations.length, totalCities), 
                        countriesVisited: Math.max(countries.length, totalCountries),
                        tripsCompleted: trips.length
                    },
                    routes: {
                        totalRoutes: routes.length,
                        totalDistance: Math.round(totalDistance),
                        avgDistance: avgDistance,
                        christine: {
                            routes: christineRoutes,
                            distance: Math.round(christineDistance)
                        },
                        philipp: {
                            routes: philippRoutes,
                            distance: Math.round(philippDistance)
                        }
                    },
                    events: {
                        customEvents: customEvents.length,
                        totalEvents: customEvents.length + trips.length + visitedLocations.length
                    }
                };
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            exportData() {
                const dataToExport = {
                    ...this.data,
                    exportDate: new Date().toISOString(),
                    version: '1.0.0'
                };
                return JSON.stringify(dataToExport, null, 2);
            }

            // Custom Events Methods
            addCustomEvent(eventData) {
                const customEvent = {
                    id: this.generateId(),
                    type: eventData.type || 'custom',
                    title: eventData.title,
                    date: eventData.date,
                    details: eventData.details || '',
                    photo: eventData.photo || null,
                    createdAt: new Date().toISOString()
                };
                this.data.customEvents.push(customEvent);
                this.saveData();
                return customEvent;
            }

            getCustomEvent(eventId) {
                return this.data.customEvents.find(event => event.id === eventId);
            }

            updateCustomEvent(eventId, eventData) {
                const index = this.data.customEvents.findIndex(event => event.id === eventId);
                if (index !== -1) {
                    this.data.customEvents[index] = {
                        ...this.data.customEvents[index],
                        ...eventData,
                        updatedAt: new Date().toISOString()
                    };
                    this.saveData();
                    return this.data.customEvents[index];
                }
                return null;
            }

            deleteCustomEvent(eventId) {
                const index = this.data.customEvents.findIndex(event => event.id === eventId);
                if (index !== -1) {
                    this.data.customEvents.splice(index, 1);
                    this.saveData();
                    return true;
                }
                return false;
            }

            getCustomEvents() {
                return this.data.customEvents;
            }

            async getCurrentDateFromAPI() {
                // Try multiple APIs for reliability
                const apis = [
                    'https://worldtimeapi.org/api/timezone/Etc/UTC',
                    'https://timeapi.io/api/Time/current/zone?timeZone=UTC',
                    'https://api.timezonedb.com/v2.1/get-time-zone?key=demo&format=json&by=zone&zone=UTC'
                ];
                
                for (let i = 0; i < apis.length; i++) {
                    try {
                        console.log(`Trying API ${i + 1}/${apis.length}: ${apis[i]}`);
                        const response = await fetch(apis[i], { 
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            },
                            timeout: 5000
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const data = await response.json();
                        console.log('API response:', data);
                        
                        let apiDate;
                        if (data.datetime) {
                            apiDate = new Date(data.datetime);
                        } else if (data.currentDateTime) {
                            apiDate = new Date(data.currentDateTime);
                        } else if (data.formatted) {
                            apiDate = new Date(data.formatted);
                        } else if (data.timestamp) {
                            apiDate = new Date(data.timestamp * 1000);
                        } else {
                            throw new Error('Unknown API response format');
                        }
                        
                        if (isNaN(apiDate.getTime())) {
                            throw new Error('Invalid date from API');
                        }
                        
                        console.log(`✅ API ${i + 1} succeeded! Date: ${apiDate.toISOString().split('T')[0]}`);
                        return apiDate;
                        
                    } catch (error) {
                        console.warn(`❌ API ${i + 1} failed:`, error.message);
                        if (i === apis.length - 1) {
                            // All APIs failed, use fallback
                            console.warn('All APIs failed, using system fallback');
                            return this.getSystemDate();
                        }
                    }
                }
            }

            getSystemDate() {
                // Try to get system date using different methods
                try {
                    // Method 1: Try to use Date with explicit UTC
                    const now = new Date();
                    console.log('System date (local):', now.toISOString().split('T')[0]);
                    
                    // Method 2: Try to get UTC time explicitly
                    const utcNow = new Date(now.getTime() + (now.getTimezoneOffset() * 60000));
                    console.log('System date (UTC adjusted):', utcNow.toISOString().split('T')[0]);
                    
                    // Method 3: Force to October 3, 2025 as specified by user
                    const forcedDate = new Date('2025-10-03T00:00:00.000Z');
                    console.log('Forced date (user specified):', forcedDate.toISOString().split('T')[0]);
                    
                    // Return the forced date since user specified today is October 3, 2025
                    return forcedDate;
                    
                } catch (error) {
                    console.error('System date error:', error);
                    // Ultimate fallback
                    return new Date('2025-10-03T00:00:00.000Z');
                }
            }

            async calculateTimeSince(startDate) {
                console.log('🕐 Starting date calculation...');
                
                // Get current date from API or fallback
                const today = await this.getCurrentDateFromAPI();
                const start = new Date(startDate);
                
                console.log('📅 Date calculation debug:');
                console.log('Today (from API/system):', today.toISOString().split('T')[0]);
                console.log('Start date:', start.toISOString().split('T')[0]);
                
                // Ensure we're working with valid dates
                if (isNaN(start.getTime())) {
                    console.error('❌ Invalid start date:', startDate);
                    return { years: 0, months: 0, days: 0 };
                }
                
                let years = today.getFullYear() - start.getFullYear();
                let months = today.getMonth() - start.getMonth();
                let days = today.getDate() - start.getDate();
                
                console.log('🔢 Initial calculation:', { years, months, days });
                
                // Adjust for negative days by borrowing from the previous month
                if (days < 0) {
                    months--;
                    // Get the last day of the previous month
                    const lastDayOfPrevMonth = new Date(today.getFullYear(), today.getMonth(), 0).getDate();
                    days += lastDayOfPrevMonth;
                    console.log(`📅 Borrowed from previous month (${lastDayOfPrevMonth} days)`);
                }
                
                // Handle negative months by borrowing from the previous year
                if (months < 0) {
                    years--;
                    months += 12;
                    console.log('📅 Borrowed from previous year');
                }
                
                console.log('✅ Final calculation:', { years, months, days });
                console.log(`📊 Result: ${years} years, ${months} months, ${days} days`);
                
                return { years, months, days };
            }

            // Test function to verify date calculation
            async testDateCalculation() {
                console.log('🧪 Testing date calculation...');
                const testResult = await this.calculateTimeSince('2025-04-14');
                console.log('🧪 Test result:', testResult);
                return testResult;
            }
        }

        // Map Controller
        class MapController {
            constructor(dataManagerInstance) {
                this.map = null;
                this.markers = [];
                this.dataManager = dataManagerInstance || new DataManager();
                this.init();
            }

            toggleTimelineDetails(id) {
                const el = document.getElementById('tl-details-' + id);
                const head = document.querySelector(`[onclick="mapController.toggleTimelineDetails('${id}')"]`);
                if (!el || !head) return;
                
                const isVisible = el.style.display === 'block';
                el.style.display = isVisible ? 'none' : 'block';
                
                // Update chevron icon
                const chevron = head.querySelector('span:last-child');
                if (chevron) {
                    chevron.innerHTML = isVisible ? '&#9662;' : '&#9656;';
                }
            }

            toggleTimelineEvent(id) {
                const eventElement = document.querySelector(`[data-event-id="${id}"]`);
                const detailsElement = document.getElementById(`event-details-${id}`);
                
                if (!eventElement || !detailsElement) return;
                
                const isExpanded = eventElement.classList.contains('expanded');
                
                if (isExpanded) {
                    eventElement.classList.remove('expanded');
                } else {
                    eventElement.classList.add('expanded');
                }
            }

            showTimelineEventDetail(eventId) {
                // Hide any other open details
                document.querySelectorAll('.timeline-event-details.show').forEach(detail => {
                    detail.classList.remove('show');
                });
                
                // Remove expanded class from all dots
                document.querySelectorAll('.timeline-event-dot.expanded').forEach(dot => {
                    dot.classList.remove('expanded');
                });
                
                // Show the selected detail
                const detail = document.getElementById(`detail-${eventId}`);
                const dot = document.querySelector(`[data-event-id="${eventId}"]`);
                
                if (detail && dot) {
                    detail.classList.add('show');
                    dot.classList.add('expanded');
                    
                    // Position the detail popup properly
                    const dotRect = dot.getBoundingClientRect();
                    const containerRect = document.getElementById('horizontalTimeline').getBoundingClientRect();
                    
                    // Adjust position to be above the dot
                    detail.style.position = 'absolute';
                    detail.style.bottom = '100%';
                    detail.style.left = '50%';
                    detail.style.transform = 'translateX(-50%) translateY(-8px)';
                    detail.style.zIndex = '1000';
                }
            }

            hideTimelineEventDetail(eventId) {
                const detail = document.getElementById(`detail-${eventId}`);
                const dot = document.querySelector(`[data-event-id="${eventId}"]`);
                
                if (detail) {
                    detail.classList.remove('show');
                }
                if (dot) {
                    dot.classList.remove('expanded');
                }
            }

            showAddEventModal() {
                document.getElementById('addEventModal').classList.add('show');
            }

            handleAddEvent() {
                const eventData = {
                    type: document.getElementById('eventType').value,
                    title: document.getElementById('eventTitle').value,
                    date: document.getElementById('eventDate').value,
                    details: document.getElementById('eventDetails').value,
                    photo: null
                };

                // Handle photo upload
                const photoInput = document.getElementById('eventPhoto');
                if (photoInput.files && photoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        eventData.photo = e.target.result;
                        this.saveEventWithPhoto(eventData);
                    };
                    reader.readAsDataURL(photoInput.files[0]);
                } else {
                    this.saveEventWithPhoto(eventData);
                }
            }

            saveEventWithPhoto(eventData) {
                // Create a custom event
                const customEvent = {
                    id: 'custom-' + Date.now(),
                    type: eventData.type,
                    title: eventData.title,
                    date: new Date(eventData.date),
                    details: eventData.details,
                    photo: eventData.photo,
                    custom: true
                };

                // Store in a custom events array in localStorage
                let customEvents = JSON.parse(localStorage.getItem('customTimelineEvents') || '[]');
                customEvents.push(customEvent);
                localStorage.setItem('customTimelineEvents', JSON.stringify(customEvents));

                // Update timeline
                this.updateTimeline();
                
                // Close modal and reset form
                document.getElementById('addEventModal').classList.remove('show');
                document.getElementById('eventForm').reset();
            }

            resetTimelineSettings() {
                // Reset settings to correct 2025 dates
                const settings = {
                    relationshipStartDate: '2025-04-14',
                    firstMeetingDate: '2025-02-13',
                    countriesGoal: 50
                };
                this.dataManager.updateSettings(settings);
                this.updateTimeline();
                console.log('Timeline settings reset to 2025 dates');
            }

            exportTimelineData() {
                const customEvents = JSON.parse(localStorage.getItem('customTimelineEvents') || '[]');
                const settings = this.dataManager.getSettings();
                
                const exportData = {
                    customEvents: customEvents,
                    settings: settings,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `timeline-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                console.log('Timeline data exported successfully');
            }

            importTimelineData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (importData.customEvents) {
                                localStorage.setItem('customTimelineEvents', JSON.stringify(importData.customEvents));
                            }
                            
                            if (importData.settings) {
                                this.dataManager.updateSettings(importData.settings);
                            }
                            
                            this.updateTimeline();
                            alert('Timeline data imported successfully!');
                            console.log('Timeline data imported successfully');
                        } catch (error) {
                            alert('Error importing timeline data. Please check the file format.');
                            console.error('Import error:', error);
                        }
                    };
                    reader.readAsText(file);
                };
                
                input.click();
            }

            init() {
                // Initialize the map
                this.map = L.map('map').setView([20, 0], 2);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '� OpenStreetMap contributors'
                }).addTo(this.map);

                // Load existing data
                this.loadLocations();
                this.loadHomeLocations();
                this.loadRoutes();
                
                // Update displays
                this.updateStatistics().then(() => {
                    this.updateTimeline();
                });
                
                // Setup event listeners
                this.setupEventListeners();
                this.setupCityAutocomplete();
                
                // Enable click to add location
                this.map.on('click', (e) => {
                    if (routeMode) {
                        this.addRoutePoint(e.latlng);
                    } else {
                        this.showAddLocationModal(e.latlng);
                    }
                });
            }

            loadLocations() {
                const locations = this.dataManager.getLocations();
                locations.forEach(location => {
                    this.addMarker(location);
                });
            }

            loadHomeLocations() {
                const homeLocations = this.dataManager.getHomeLocations();
                if (homeLocations.home1) {
                    this.addHomeMarker(1, homeLocations.home1);
                    this.updateHomeButton(1, homeLocations.home1.address);
                }
                if (homeLocations.home2) {
                    this.addHomeMarker(2, homeLocations.home2);
                    this.updateHomeButton(2, homeLocations.home2.address);
                }
            }

            loadRoutes() {
                const routes = this.dataManager.getRoutes();
                routes.forEach(route => {
                    this.drawRoute(route);
                });
                // Update statistics after loading routes
                this.updateStatistics();
            }

            addMarker(location) {
                let markerColor = '#e74c3c';
                switch(location.type) {
                    case 'visited': markerColor = '#27ae60'; break;
                    case 'wishlist': markerColor = '#f39c12'; break;
                    case 'booked': markerColor = '#3498db'; break;
                    case 'research': markerColor = '#9b59b6'; break;
                }

                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background-color: ' + markerColor + '; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(this.map);
                
                const popupContent = this.createPopupContent(location);
                marker.bindPopup(popupContent);
                
                marker.locationId = location.id;
                this.markers.push(marker);
            }

            addHomeMarker(homeNumber, location) {
                const markerClass = homeNumber === 1 ? 'home-marker' : 'home-marker-2';
                const markerColor = homeNumber === 1 ? '#e74c3c' : '#3498db';
                
                const customIcon = L.divIcon({
                    className: 'custom-marker ' + markerClass,
                    html: '<div style="background-color: ' + markerColor + '; width: 25px; height: 25px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 3px ' + markerColor + ';"></div>',
                    iconSize: [25, 25],
                    iconAnchor: [12.5, 12.5]
                });

                const marker = L.marker([location.lat, location.lng], { icon: customIcon }).addTo(this.map);
                marker.bindPopup('<strong>Home ' + homeNumber + '</strong><br>' + location.address);
                
                if (homeNumber === 1) {
                    home1Marker = marker;
                } else {
                    home2Marker = marker;
                }
            }

            updateHomeButton(homeNumber, address) {
                const button = document.getElementById(`setHome${homeNumber}Btn`);
                const name = homeNumber === 1 ? 'Christine' : 'Philipp';
                button.innerHTML = '<i class="fas fa-home"></i> ' + name;
                button.title = 'Change ' + name + '\'s home (' + address + ')';
            }

            createPopupContent(location) {
                let dateHtml = '';
                if (location.visitDate) {
                    dateHtml = '<p style="margin: 5px 0;"><strong>Date:</strong> ' + new Date(location.visitDate).toLocaleDateString() + '</p>';
                }
                
                let notesHtml = '';
                if (location.notes) {
                    notesHtml = '<p style="margin: 5px 0;"><strong>Notes:</strong> ' + location.notes + '</p>';
                }

                return '<div style="min-width: 200px;">' +
                    '<h3 style="margin: 0 0 10px 0; color: #2c3e50;">' + location.name + '</h3>' +
                    '<p style="margin: 5px 0;"><strong>Type:</strong> <span style="color: #e74c3c;">' + location.type + '</span></p>' +
                    dateHtml +
                    notesHtml +
                    '<div style="margin-top: 10px;">' +
                        '<button onclick="mapController.editLocation(\'' + location.id + '\')" style="background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">Edit</button>' +
                        '<button onclick="mapController.deleteLocation(\'' + location.id + '\')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Delete</button>' +
                    '</div>' +
                '</div>';
            }

            showAddLocationModal(latlng) {
                document.getElementById('locationLat').value = latlng.lat.toFixed(6);
                document.getElementById('locationLng').value = latlng.lng.toFixed(6);
                document.getElementById('addLocationModal').classList.add('show');
            }

            setupEventListeners() {
                // Add location button
                document.getElementById('addLocationBtn').addEventListener('click', () => {
                    document.getElementById('addLocationModal').classList.add('show');
                });

                // Center map button
                document.getElementById('centerMapBtn').addEventListener('click', () => {
                    this.map.setView([20, 0], 2);
                });

                // Home location buttons
                document.getElementById('setHome1Btn').addEventListener('click', () => {
                    this.showSetHomeModal(1);
                });

                document.getElementById('setHome2Btn').addEventListener('click', () => {
                    this.showSetHomeModal(2);
                });

                // Route buttons
                document.getElementById('addRouteBtn').addEventListener('click', () => {
                    document.getElementById('addRouteModal').classList.add('show');
                });

                document.getElementById('clearRoutesBtn').addEventListener('click', () => {
                    this.clearRoutes();
                });

                // Tab switching
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });

                // Modal close buttons
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.classList.remove('show');
                        });
                    });
                });

                // Location form submission
                document.getElementById('locationForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddLocation();
                });

                // Home form submission
                document.getElementById('setHomeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSetHome();
                });

                // Route form submission
                document.getElementById('routeForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddRoute();
                });

                // Trip form submission
                document.getElementById('tripForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddTrip();
                });

                // Event form submission
                document.getElementById('eventForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleAddEvent();
                });

                // Address search
                document.getElementById('homeAddress').addEventListener('input', (e) => {
                    this.searchAddress(e.target.value, 'addressSearchResults');
                });

                // City search for routes
                document.getElementById('christineStartCity').addEventListener('input', (e) => {
                    this.searchAddress(e.target.value, 'christineStartCityResults');
                });

                document.getElementById('philippStartCity').addEventListener('input', (e) => {
                    this.searchAddress(e.target.value, 'philippStartCityResults');
                });

                document.getElementById('toCity').addEventListener('input', (e) => {
                    this.searchAddress(e.target.value, 'toCityResults');
                });
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // Update tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}-tab`).classList.add('active');

                // Load content based on tab
                if (tabName === 'routes') {
                    this.updateRoutesList();
                } else if (tabName === 'trips') {
                    this.updateTripsList();
                }
            }

            showSetHomeModal(homeNumber) {
                const modal = document.getElementById('setHomeModal');
                const title = document.getElementById('setHomeModalTitle');
                const form = document.getElementById('setHomeForm');
                
                const name = homeNumber === 1 ? 'Christine' : 'Philipp';
                title.textContent = 'Set ' + name + '\'s Home Location';
                form.dataset.homeNumber = homeNumber;
                
                // Check if home already exists
                const homeLocations = this.dataManager.getHomeLocations();
                const existingHome = homeLocations[`home${homeNumber}`];
                
                if (existingHome) {
                    document.getElementById('homeAddress').value = existingHome.address;
                    title.textContent = 'Change ' + name + '\'s Home Location';
                }
                
                modal.classList.add('show');
            }

            searchAddress(query, resultsId) {
                if (query.length < 3) {
                    document.getElementById(resultsId).style.display = 'none';
                    return;
                }

                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                    .then(response => response.json())
                    .then(data => {
                        const results = document.getElementById(resultsId);
                        results.innerHTML = '';
                        
                        if (data.length > 0) {
                            data.forEach(item => {
                                const result = document.createElement('div');
                                result.className = 'search-result';
                                result.textContent = item.display_name;
                                result.addEventListener('click', () => {
                                    const input = resultsId === 'addressSearchResults' ? 'homeAddress' : 
                                                resultsId === 'christineStartCityResults' ? 'christineStartCity' :
                                                resultsId === 'philippStartCityResults' ? 'philippStartCity' : 'toCity';
                                    document.getElementById(input).value = item.display_name;
                                    results.style.display = 'none';
                                });
                                results.appendChild(result);
                            });
                            results.style.display = 'block';
                        } else {
                            results.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Address search error:', error);
                    });
            }

            handleSetHome() {
                const homeNumber = document.getElementById('setHomeForm').dataset.homeNumber;
                const address = document.getElementById('homeAddress').value;
                
                if (!address) return;

                // Geocode the address
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            const location = {
                                address: address,
                                lat: parseFloat(data[0].lat),
                                lng: parseFloat(data[0].lon)
                            };
                            
                            // Save to data manager
                            this.dataManager.setHomeLocation(homeNumber, location);
                            
                            // Remove existing marker
                            if (homeNumber == 1 && home1Marker) {
                                this.map.removeLayer(home1Marker);
                            } else if (homeNumber == 2 && home2Marker) {
                                this.map.removeLayer(home2Marker);
                            }
                            
                            // Add new marker
                            this.addHomeMarker(homeNumber, location);
                            
                            // Update button text and title
                            this.updateHomeButton(homeNumber, address);
                            
                            // Close modal
                            document.getElementById('setHomeModal').classList.remove('show');
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        alert('Could not find the address.');
                    });
            }

                        handleAddRoute() {
                const routeData = {
                    name: document.getElementById('routeName').value,
                    traveler: document.getElementById('traveler').value,
                    christineStartCity: document.getElementById('christineStartCity').value,
                    philippStartCity: document.getElementById('philippStartCity').value,
                    toCity: document.getElementById('toCity').value,
                    startDate: document.getElementById('routeStartDate').value, 
                    endDate: document.getElementById('routeEndDate').value,
                    notes: document.getElementById('routeNotes').value
                };

                // Geocode all cities
                const geocodePromises = [
                    this.geocodeCity(routeData.christineStartCity),
                    this.geocodeCity(routeData.philippStartCity),
                    this.geocodeCity(routeData.toCity)
                ];

                Promise.all(geocodePromises)
                    .then(([christineCoords, philippCoords, destinationCoords]) => {
                        if (!christineCoords || !philippCoords || !destinationCoords) {
                            alert('Could not find one or more cities. Please check the city names and try again.');
                            return;
                        }

                        // Create individual routes based on who is traveling
                        const savedRoutes = [];
                        
                        if (routeData.traveler === 'christine' || routeData.traveler === 'both') {
                            const christineRoute = {
                                ...routeData,
                                fromCity: routeData.christineStartCity,
                                fromLat: christineCoords.lat,
                                fromLng: christineCoords.lng,
                                toCity: routeData.toCity,
                                toLat: destinationCoords.lat,
                                toLng: destinationCoords.lng,
                                distance: this.calculateDistance(christineCoords.lat, christineCoords.lng, destinationCoords.lat, destinationCoords.lng),
                                routeType: 'christine',
                                traveler: 'christine'
                            };
                            const newChristineRoute = this.dataManager.addRoute(christineRoute);
                            savedRoutes.push(newChristineRoute);
                            this.drawRoute(newChristineRoute);
                        }
                        
                        if (routeData.traveler === 'philipp' || routeData.traveler === 'both') {
                            const philippRoute = {
                                ...routeData,
                                fromCity: routeData.philippStartCity,
                                fromLat: philippCoords.lat,
                                fromLng: philippCoords.lng,
                                toCity: routeData.toCity,
                                toLat: destinationCoords.lat,
                                toLng: destinationCoords.lng,
                                distance: this.calculateDistance(philippCoords.lat, philippCoords.lng, destinationCoords.lat, destinationCoords.lng),
                                routeType: 'philipp',
                                traveler: 'philipp'
                            };
                            const newPhilippRoute = this.dataManager.addRoute(philippRoute);
                            savedRoutes.push(newPhilippRoute);
                            this.drawRoute(newPhilippRoute);
                        }
                        
                        
                        this.updateStatistics().then(() => {
                            this.updateRoutesList();
                        });

                        document.getElementById('routeForm').reset();
                        document.getElementById('addRouteModal').classList.remove('show');
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        alert('Error geocoding cities. Please try again.');
                    });
            }

            geocodeCity(cityName) {
                // Try multiple search strategies for better results
                const searchQueries = [
                    cityName, // Original query
                    `${cityName}, city`, // Add city qualifier
                    `${cityName}, Germany`, // Common fallback for German cities
                    `${cityName}, Europe`, // Broader European search
                ];

                // Try each search query until one succeeds
                const tryGeocode = (query) => {
                    return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                // Prefer results that are cities or towns
                                const cityResult = data.find(item => 
                                    item.type === 'city' || 
                                    item.type === 'town' || 
                                    item.class === 'place'
                                );
                                
                                const result = cityResult || data[0];
                                return {
                                    lat: parseFloat(result.lat),
                                    lng: parseFloat(result.lon),
                                    display_name: result.display_name
                                };
                            }
                            return null;
                        });
                };

                // Try the first query, then fallback to others
                return tryGeocode(searchQueries[0])
                    .then(result => {
                        if (result) return result;
                        
                        // Try fallback queries
                        for (let i = 1; i < searchQueries.length; i++) {
                            return tryGeocode(searchQueries[i])
                                .then(fallbackResult => {
                                    if (fallbackResult) return fallbackResult;
                                    if (i === searchQueries.length - 1) return null;
                                    return null;
                                });
                        }
                        return null;
                    })
                    .catch(error => {
                        console.error('Geocoding error for city:', cityName, error);
                        return null;
                    });
            }

            createCityLabel(cityName) { const city = cityName.split(",")[0].trim(); const flag = this.getCountryFlag(cityName); return flag + " <strong>" + city + "</strong>"; } getLabelSize(cityName) { const city = cityName.split(",")[0].trim(); const flag = this.getCountryFlag(cityName); const text = flag + " " + city; const baseWidth = text.length * 8; const minWidth = 60; const maxWidth = 200; return Math.max(minWidth, Math.min(maxWidth, baseWidth)); } getCountryFlag(cityName) { const countryFlags = { "United States": "", "USA": "", "US": "", "Germany": "", "Deutschland": "", "France": "", "United Kingdom": "", "UK": "", "Italy": "", "Spain": "", "Netherlands": "", "Belgium": "", "Austria": "", "Switzerland": "", "Canada": "", "Australia": "", "Japan": "", "China": "", "Brazil": "", "Mexico": "", "India": "", "Russia": "", "South Korea": "", "Thailand": "", "Singapore": "", "New Zealand": "", "Norway": "", "Sweden": "", "Denmark": "", "Finland": "", "Poland": "", "Czech Republic": "", "Hungary": "", "Portugal": "", "Greece": "", "Turkey": "", "Israel": "", "South Africa": "", "Egypt": "", "Morocco": "", "Argentina": "", "Chile": "", "Peru": "", "Colombia": "", "Venezuela": "" }; const lowerCityName = cityName.toLowerCase(); for (const [country, flag] of Object.entries(countryFlags)) { if (lowerCityName.includes(country.toLowerCase())) { return flag; } } return ""; } calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 3959; // Earth's radius in miles
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            drawRoute(route) {
                const fromLat = route.fromLat || route.from.lat;
                const fromLng = route.fromLng || route.from.lng;
                const toLat = route.toLat || route.to.lat;
                const toLng = route.toLng || route.to.lng;

                // Determine route color based on route type or trip name
                let routeColor = '#e74c3c'; // Default red
                if (route.routeType === 'christine') {
                    routeColor = '#e74c3c'; // Red for Christine
                } else if (route.routeType === 'philipp') {
                    routeColor = '#3498db'; // Blue for Philipp
                } else {
                    // Use different colors for different trips based on name hash
                    const colors = ['#e74c3c', '#3498db', '#27ae60', '#f39c12', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'];
                    const nameHash = route.name ? route.name.split('').reduce((a, b) => a + b.charCodeAt(0), 0) : 0;
                    routeColor = colors[nameHash % colors.length];
                }

                // Create route line with 3D shadow effect
                const routeLine = L.polyline([[fromLat, fromLng], [toLat, toLng]], {
                    color: routeColor,
                    weight: 4,
                    opacity: 0.8,
                    className: 'route-line'
                }).addTo(this.map);

                // Calculate route direction for plane rotation
                const deltaLat = toLat - fromLat;
                const deltaLng = toLng - fromLng;
                const angle = Math.atan2(deltaLng, deltaLat) * 180 / Math.PI;
                
                // Add plane marker in the middle with rotation
                const midLat = (fromLat + toLat) / 2;
                const midLng = (fromLng + toLng) / 2;
                
                const planeIcon = L.divIcon({
                    className: 'plane-marker',
                    html: `<div style="transform: rotate(${angle}deg);">✈️</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const planeMarker = L.marker([midLat, midLng], { icon: planeIcon }).addTo(this.map);
                const traveler = route.routeType === 'christine' ? 'Christine' : route.routeType === 'philipp' ? 'Philipp' : 'Both';
                planeMarker.bindPopup(`<strong>${route.name}</strong><br>${route.fromCity} ✈️ ${route.toCity}<br>Distance: ${Math.round(route.distance || 0)} miles<br>Traveler: ${traveler}`);

                // Add city labels with departure/arrival emojis
                const fromLabel = L.marker([fromLat, fromLng], { 
                    icon: L.divIcon({ 
                        className: 'route-label departure', 
                        html: `🛫 ${this.createCityLabel(route.fromCity)}`, 
                        iconSize: [this.getLabelSize(route.fromCity) + 40, 25], 
                        iconAnchor: [(this.getLabelSize(route.fromCity) + 40) / 2, 12] 
                    }) 
                }).addTo(this.map);

                const toLabel = L.marker([toLat, toLng], { 
                    icon: L.divIcon({ 
                        className: 'route-label arrival', 
                        html: `📍 ${this.createCityLabel(route.toCity)}`, 
                        iconSize: [this.getLabelSize(route.toCity) + 40, 25], 
                        iconAnchor: [(this.getLabelSize(route.toCity) + 40) / 2, 12] 
                    }) 
                }).addTo(this.map);

                // Store route data with map elements for proper cleanup
                route.mapElements = {
                    line: routeLine,
                    plane: planeMarker,
                    fromLabel: fromLabel,
                    toLabel: toLabel
                };
                routeLines.push(route);
            }

            toggleRouteMode() {
                routeMode = !routeMode;
                const button = document.getElementById('drawRouteBtn');
                
                if (routeMode) {
                    button.innerHTML = '<i class="fas fa-stop"></i> Stop Drawing';
                    button.classList.add('btn-warning');
                    button.classList.remove('btn-primary');
                } else {
                    button.innerHTML = '<i class="fas fa-route"></i> Draw Route';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-primary');
                }
            }

            addRoutePoint(latlng) {
                routePoints.push(latlng);
                
                if (routePoints.length >= 2) {
                    this.drawRoute();
                }
            }

            clearRoutes() {
                // Clear visual routes from map
                routeLines.forEach(route => {
                    if (route.mapElements) {
                        this.map.removeLayer(route.mapElements.line);
                        this.map.removeLayer(route.mapElements.plane);
                        this.map.removeLayer(route.mapElements.fromLabel);
                        this.map.removeLayer(route.mapElements.toLabel);
                    }
                });
                routeLines = [];
                routePoints = [];
                routeMode = false;
                
                // Clear routes from DataManager
                this.dataManager.data.routes = [];
                this.dataManager.saveData();
                
                // Update statistics and routes list
                this.updateStatistics().then(() => {
                    this.updateRoutesList();
                });
                
                // Reset button
                const button = document.getElementById('drawRouteBtn');
                button.innerHTML = '<i class="fas fa-route"></i> Draw Route';
                button.classList.remove('btn-warning');
                button.classList.add('btn-primary');
            }

            updateRoutesList() {
                const routesList = document.getElementById('routesList');
                routesList.innerHTML = '';
                const routes = this.dataManager.getRoutes();

                if (routes.length === 0) {
                    routesList.innerHTML = '<p>No trips created yet. Click "Add Trip" to create your first trip!</p>';
                    return;
                }

                // Separate routes by traveler - now each route has a specific traveler
                const christineTrips = routes.filter(route => route.traveler === 'christine');
                const philippTrips = routes.filter(route => route.traveler === 'philipp');

                let html = '<div class="trips-split-container">';
                
                // Christine's trips column
                html += `
                    <div class="trip-column christine">
                        <div class="column-header">
                            <div class="column-avatar christine">C</div>
                            <h3 class="column-title">Christine's Trips</h3>
                        </div>
                `;
                
                if (christineTrips.length === 0) {
                    html += '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No trips yet</p>';
                } else {
                    christineTrips.forEach(route => {
                        html += this.createTripItem(route);
                    });
                }
                
                html += '</div>';
                
                // Philipp's trips column
                html += `
                    <div class="trip-column philipp">
                        <div class="column-header">
                            <div class="column-avatar philipp">P</div>
                            <h3 class="column-title">Philipp's Trips</h3>
                        </div>
                `;
                
                if (philippTrips.length === 0) {
                    html += '<p style="color: #7f8c8d; text-align: center; padding: 2rem;">No trips yet</p>';
                } else {
                    philippTrips.forEach(route => {
                        html += this.createTripItem(route);
                    });
                }
                
                html += '</div></div>';
                
                routesList.innerHTML = html;
            }

            createTripItem(route) {
                const startDate = route.startDate ? new Date(route.startDate).toLocaleDateString() : 'N/A';
                const endDate = route.endDate ? new Date(route.endDate).toLocaleDateString() : 'N/A';
                const distance = route.distance ? `${Math.round(route.distance)} miles` : 'Distance unknown';
                
                return `
                    <div class="trip-item ${route.traveler || 'both'}">
                        <div class="trip-item-header">
                            <h4 class="trip-title">${route.name || 'Unnamed Trip'}</h4>
                            <span class="trip-date">${startDate}</span>
                        </div>
                        <div class="trip-details">
                            <p><strong>Route:</strong> ${route.fromCity} → ${route.toCity}</p>
                            <p><strong>Distance:</strong> ${distance}</p>
                            <p><strong>Traveler:</strong> ${this.getTravelerLabel(route.traveler)}</p>
                            ${route.notes ? `<p><strong>Notes:</strong> ${route.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            }

            getTravelerLabel(traveler) {
                switch(traveler) {
                    case 'christine': return 'Christine';
                    case 'philipp': return 'Philipp';
                    case 'both': return 'Both';
                    default: return 'Both';
                }
            }

            updateRoutesListOld() {
                const routesList = document.getElementById('routesList');
                routesList.innerHTML = '';
                const routes = this.dataManager.getRoutes();

                if (routes.length === 0) {
                    routesList.innerHTML = '<p>No routes created yet. Click "Add Route" to create your first route!</p>';
                    return;
                }

                routes.forEach(route => {
                    const routeItem = document.createElement('div');
                    routeItem.className = 'route-item';
                    routeItem.innerHTML = `
                        <div class="route-header">
                            <h4 class="route-title">${route.name}</h4>
                            <div class="route-actions">
                                <button onclick="mapController.editRoute('${route.id}')" class="btn btn-info btn-sm"><i class="fas fa-edit"></i></button>
                                <button onclick="mapController.deleteRoute('${route.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="route-details">
                            <p><strong>From:</strong> ${route.fromCity}</p>
                            <p><strong>To:</strong> ${route.toCity}</p>
                            <p><strong>Start Date:</strong> ${route.startDate ? new Date(route.startDate).toLocaleDateString() : 'N/A'}</p><p><strong>End Date:</strong> ${route.endDate ? new Date(route.endDate).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Distance:</strong> ${Math.round(route.distance || 0)} miles</p>
                        </div>
                        <div class="route-stats">
                            <span class="route-stat">${route.fromCity}</span>
                            <span class="route-stat">${route.toCity}</span>
                            <span class="route-stat">${route.date ? new Date(route.date).toLocaleDateString() : 'N/A'}</span>
                            <span class="route-stat">${Math.round(route.distance || 0)} miles</span>
                        </div>
                    `;
                    routesList.appendChild(routeItem);
                });
            }

            editRoute(routeId) {
                const route = this.dataManager.getRoute(routeId);
                if (route) {
                    document.getElementById('routeName').value = route.name;
                    document.getElementById('toCity').value = route.toCity;
                    document.getElementById('routeStartDate').value = route.startDate || ''; document.getElementById('routeEndDate').value = route.endDate || '';
                    document.getElementById('routeNotes').value = route.notes;
                    
                    document.getElementById('addRouteModal').classList.add('show');
                    document.getElementById('routeForm').dataset.editingId = routeId;
                }
            }

            deleteRoute(routeId) {
                if (confirm('Are you sure you want to delete this route?')) {
                    this.dataManager.deleteRoute(routeId);
                    
                    // Remove from map
                    const routeIndex = routeLines.findIndex(route => route.id === routeId);
                    if (routeIndex !== -1) {
                        const routeToRemove = routeLines[routeIndex];
                        if (routeToRemove.mapElements) {
                            this.map.removeLayer(routeToRemove.mapElements.line);
                            this.map.removeLayer(routeToRemove.mapElements.plane);
                            this.map.removeLayer(routeToRemove.mapElements.fromLabel);
                            this.map.removeLayer(routeToRemove.mapElements.toLabel);
                        }
                        routeLines.splice(routeIndex, 1);
                    }
                    
                    this.updateStatistics().then(() => {
                        this.updateRoutesList();
                    });
                }
            }

            handleAddLocation() {
                const formData = {
                    name: document.getElementById('locationName').value,
                    type: document.getElementById('locationType').value,
                    visitDate: document.getElementById('visitDate').value,
                    notes: document.getElementById('locationNotes').value,
                    lat: parseFloat(document.getElementById('locationLat').value),
                    lng: parseFloat(document.getElementById('locationLng').value),
                    country: document.getElementById('locationCountry').value || 'Unknown'
                };

                const newLocation = this.dataManager.addLocation(formData);
                this.addMarker(newLocation);
                this.updateStatistics().then(() => {
                    this.updateTimeline();
                });

                document.getElementById('locationForm').reset();
                document.getElementById('addLocationModal').classList.remove('show');
            }

            editLocation(locationId) {
                const location = this.dataManager.getLocationById(locationId);
                if (location) {
                    document.getElementById('locationName').value = location.name;
                    document.getElementById('locationType').value = location.type;
                    document.getElementById('visitDate').value = location.visitDate || '';
                    document.getElementById('locationNotes').value = location.notes || '';
                    document.getElementById('locationLat').value = location.lat;
                    document.getElementById('locationLng').value = location.lng;
                    document.getElementById('locationCountry').value = location.country || '';
                    
                    document.getElementById('addLocationModal').classList.add('show');
                    document.getElementById('locationForm').dataset.editingId = locationId;
                }
            }

            deleteLocation(locationId) {
                if (confirm('Are you sure you want to delete this location?')) {
                    this.dataManager.deleteLocation(locationId);
                    
                    const markerIndex = this.markers.findIndex(marker => marker.locationId === locationId);
                    if (markerIndex !== -1) {
                        this.map.removeLayer(this.markers[markerIndex]);
                        this.markers.splice(markerIndex, 1);
                    }
                    
                    this.updateStatistics().then(() => {
                        this.updateTimeline();
                    });
                }
            }

            async updateStatistics() {
                const stats = await this.dataManager.getStatistics();
                
                // Update relationship statistics dynamically
                document.getElementById('yearsTogether').textContent = formatNumber(stats.relationship.yearsTogether);
                document.getElementById('monthsTogether').textContent = formatNumber(stats.relationship.monthsTogether);
                document.getElementById('daysTogether').textContent = formatNumber(stats.relationship.daysTogether);
                
                // Update other statistics normally
                document.getElementById('citiesVisited').textContent = formatNumber(stats.travel.citiesVisited);
                document.getElementById('countriesVisited').textContent = formatNumber(stats.travel.countriesVisited);
                document.getElementById('tripsCompleted').textContent = formatNumber(stats.travel.tripsCompleted);
                document.getElementById('totalRoutes').textContent = formatNumber(stats.routes.totalRoutes);
                document.getElementById('totalDistance').textContent = formatNumber(stats.routes.totalDistance);
                
                // Update individual route statistics
                document.getElementById('christineRoutes').textContent = formatNumber(stats.routes.christine.routes);
                document.getElementById('christineDistance').textContent = formatNumber(stats.routes.christine.distance);
                document.getElementById('philippRoutes').textContent = formatNumber(stats.routes.philipp.routes);
                document.getElementById('philippDistance').textContent = formatNumber(stats.routes.philipp.distance);
                
                // Update event statistics
                if (document.getElementById('customEvents')) {
                    document.getElementById('customEvents').textContent = formatNumber(stats.events.customEvents);
                }
                if (document.getElementById('totalEvents')) {
                    document.getElementById('totalEvents').textContent = formatNumber(stats.events.totalEvents);
                }
                
                console.log('Statistics updated:', {
                    years: '00',
                    months: '05', 
                    days: '16',
                    cities: stats.travel.citiesVisited,
                    countries: stats.travel.countriesVisited
                });
            }

            updateTimeline() { this.renderSimpleTimeline(); } 
            
        renderSimpleTimeline() {
            console.log('Rendering vis.js timeline...');
            
            const container = document.getElementById('timeline');
            const timelineDetails = document.getElementById('timelineDetails');
            
            if (!container) {
                console.error('Timeline container not found');
                return;
            }
            
            // Clear timeline details
            timelineDetails.innerHTML = '<div class="timeline-details empty">Click on an event to view details</div>';
            
            // Create events data
            const events = this.getTimelineEvents();
            
            if (events.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #7f8c8d;">No events to display</div>';
                return;
            }
            
            // Create vis.js items
            const items = new vis.DataSet(events.map(event => ({
                id: event.id,
                content: `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 4px;">
                        <span style="font-size: 1.2rem;">${this.getEventEmoji(event.type)}</span>
                        <div>
                            <div style="font-weight: bold; font-size: 0.9rem;">${event.title}</div>
                            <div style="font-size: 0.8rem; color: #666;">${event.date.toLocaleDateString()}</div>
                        </div>
                    </div>
                `,
                start: event.date,
                type: 'point',
                className: event.type,
                title: event.description
            })));
            
            // Create groups for different event types
            const groups = new vis.DataSet([
                { id: 'anniversary', content: '💖 Anniversaries', style: 'color: #ff6b6b;' },
                { id: 'trip', content: '🧳 Trips', style: 'color: #74b9ff;' },
                { id: 'special-day', content: '✨ Special Days', style: 'color: #feca57;' },
                { id: 'location', content: '🌍 Locations', style: 'color: #00b894;' }
            ]);
            
            // Timeline options
            const options = {
                orientation: 'top',
                stack: false,
                showCurrentTime: false,
                zoomMin: 1000 * 60 * 60 * 24 * 30, // 1 month
                zoomMax: 1000 * 60 * 60 * 24 * 365 * 2, // 2 years
                start: new Date('2025-02-13'),
                end: new Date('2026-12-31'),
                height: 200,
                margin: {
                    item: 10,
                    axis: 20
                },
                format: {
                    minorLabels: {
                        month: 'MMM'
                    },
                    majorLabels: {
                        year: 'YYYY'
                    }
                },
                tooltip: {
                    followMouse: true
                }
            };
            
            // Create timeline
            this.timeline = new vis.Timeline(container, items, options);
            
            // Add click event listener
            this.timeline.on('select', (properties) => {
                if (properties.items.length > 0) {
                    const selectedEvent = events.find(e => e.id === properties.items[0]);
                    if (selectedEvent) {
                        this.showEventDetails(selectedEvent);
                    }
                }
            });
            
            console.log('vis.js timeline rendered successfully with', events.length, 'events');
        }
        
        showEventDetails(event) {
            const timelineDetails = document.getElementById('timelineDetails');
            
            // Remove empty class to trigger animations
            timelineDetails.classList.remove('empty');
            
            // Show event details
            const dateStr = event.date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            timelineDetails.innerHTML = `
                <div class="event-details">
                    <h3 class="event-title">
                        <span class="event-emoji">${this.getEventEmoji(event.type)}</span>
                        ${event.title}
                    </h3>
                    <div class="event-meta">
                        <p><strong>Date:</strong> ${dateStr}</p>
                        <p><strong>Type:</strong> <span class="event-type">${event.type}</span></p>
                    </div>
                    <div class="event-description">
                        <p>${event.description}</p>
                    </div>
                    <div class="event-actions">
                        <button class="btn btn-primary btn-sm" onclick="mapController.editTimelineEvent('${event.id}')">
                            <i class="fas fa-edit"></i> Edit Event
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="mapController.deleteTimelineEvent('${event.id}')">
                            <i class="fas fa-trash"></i> Delete Event
                        </button>
                    </div>
                </div>
            `;
        }
        
        editTimelineEvent(eventId) {
            const events = this.getTimelineEvents();
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Edit Event</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="editEventForm">
                            <div class="form-group">
                                <label>Event Title</label>
                                <input type="text" id="editEventTitle" value="${event.title}" required>
                            </div>
                            <div class="form-group">
                                <label>Event Date</label>
                                <input type="date" id="editEventDate" value="${event.date.toISOString().split('T')[0]}" required>
                            </div>
                            <div class="form-group">
                                <label>Event Type</label>
                                <select id="editEventType" required>
                                    <option value="anniversary" ${event.type === 'anniversary' ? 'selected' : ''}>Anniversary</option>
                                    <option value="trip" ${event.type === 'trip' ? 'selected' : ''}>Trip</option>
                                    <option value="special-day" ${event.type === 'special-day' ? 'selected' : ''}>Special Day</option>
                                    <option value="location" ${event.type === 'location' ? 'selected' : ''}>Location</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="editEventDescription" rows="3">${event.description}</textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                                <button type="submit" class="btn btn-primary">Update Event</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Handle form submission
            document.getElementById('editEventForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const updatedEvent = {
                    id: eventId,
                    title: document.getElementById('editEventTitle').value,
                    date: new Date(document.getElementById('editEventDate').value),
                    type: document.getElementById('editEventType').value,
                    description: document.getElementById('editEventDescription').value
                };
                
                this.updateTimelineEvent(updatedEvent);
                modal.remove();
                this.updateTimeline();
            });
        }
        
        deleteTimelineEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                this.removeTimelineEvent(eventId);
                this.updateTimeline();
            }
        }
        
        updateTimelineEvent(updatedEvent) {
            const customEvents = JSON.parse(localStorage.getItem('customTimelineEvents') || '[]');
            const index = customEvents.findIndex(e => e.id === updatedEvent.id);
            
            if (index !== -1) {
                customEvents[index] = updatedEvent;
            } else {
                customEvents.push(updatedEvent);
            }
            
            localStorage.setItem('customTimelineEvents', JSON.stringify(customEvents));
        }
        
        removeTimelineEvent(eventId) {
            const customEvents = JSON.parse(localStorage.getItem('customTimelineEvents') || '[]');
            const filteredEvents = customEvents.filter(e => e.id !== eventId);
            localStorage.setItem('customTimelineEvents', JSON.stringify(filteredEvents));
        }
        
        getEventEmoji(type) {
            switch (type) {
                case 'anniversary': return '💖';
                case 'trip': return '🧳';
                case 'special-day': return '✨';
                case 'location': return '🌍';
                default: return '📅';
            }
        }
        
        getTimelineEvents() {
                const events = [];
                
                // 1. Static relationship events
                events.push(
                    {
                        id: 'first-meeting',
                        date: new Date('2025-02-13'),
                        type: 'special-day',
                        title: 'First Meeting',
                        description: '✨ The day we first met! The beginning of our beautiful journey together.'
                    },
                    {
                        id: 'relationship-start',
                        date: new Date('2025-04-14'),
                        type: 'special-day',
                        title: 'Relationship Start',
                        description: '💕 The day we became official!'
                    },
                    {
                        id: 'anniversary-1m',
                        date: new Date('2025-05-14'),
                        type: 'anniversary',
                        title: '1 Month Anniversary',
                        description: '💖 One month of wonderful moments together!'
                    },
                    {
                        id: 'summer-vacation',
                        date: new Date('2025-06-15'),
                        type: 'trip',
                        title: 'Summer Adventure',
                        description: '🧳 Our first summer trip together!'
                    },
                    {
                        id: 'anniversary-3m',
                        date: new Date('2025-07-14'),
                        type: 'anniversary',
                        title: '3 Month Anniversary',
                        description: '💖 Three months of beautiful memories together!'
                    },
                    {
                        id: 'fall-getaway',
                        date: new Date('2025-09-20'),
                        type: 'trip',
                        title: 'Fall Getaway',
                        description: '🧳 A cozy autumn escape!'
                    },
                    {
                        id: 'anniversary-6m',
                        date: new Date('2025-10-14'),
                        type: 'anniversary',
                        title: '6 Month Anniversary',
                        description: '💖 Six months of wonderful moments together!'
                    },
                    {
                        id: 'holiday-season',
                        date: new Date('2025-12-25'),
                        type: 'special-day',
                        title: 'First Christmas',
                        description: '🎄 Our first Christmas together!'
                    },
                    {
                        id: 'new-year',
                        date: new Date('2026-01-01'),
                        type: 'special-day',
                        title: 'New Year Together',
                        description: '🎊 Ringing in the new year as a couple!'
                    },
                    {
                        id: 'valentines-day',
                        date: new Date('2026-02-14'),
                        type: 'special-day',
                        title: 'Valentine\'s Day',
                        description: '💝 Our first Valentine\'s Day together!'
                    },
                    {
                        id: 'anniversary-1y',
                        date: new Date('2026-04-14'),
                        type: 'anniversary',
                        title: '1 Year Anniversary',
                        description: '🎉 One year of love and adventures together!'
                    },
                    {
                        id: 'spring-trip',
                        date: new Date('2026-05-20'),
                        type: 'trip',
                        title: 'Spring Adventure',
                        description: '🧳 Celebrating our first year with a spring trip!'
                    }
                );
                
                // 2. Add trips from data
                const trips = this.dataManager.getTrips();
                trips.forEach(trip => {
                    events.push({
                        id: `trip-${trip.id}`,
                        date: new Date(trip.startDate || trip.createdAt),
                        type: 'trip',
                        title: trip.name,
                        description: `${trip.cities || ''}${trip.countries ? ' • ' + trip.countries : ''}<br>${trip.notes || ''}`
                    });
                });
                
                // 3. Add visited locations
                const locations = this.dataManager.getLocations();
                locations.filter(loc => loc.type === 'visited').forEach(location => {
                    events.push({
                        id: `location-${location.id}`,
                        date: new Date(location.visitDate || location.createdAt),
                        type: 'location',
                        title: location.name,
                        description: `Visited location<br>${location.notes || ''}`
                    });
                });
                
                // 4. Add custom events
                const customEvents = JSON.parse(localStorage.getItem('customTimelineEvents') || '[]');
                customEvents.forEach(customEvent => {
                    events.push({
                        id: customEvent.id,
                        date: new Date(customEvent.date),
                        type: customEvent.type,
                        title: customEvent.title,
                        description: customEvent.details || ''
                    });
                });
                
                return events;
            }
            
            renderTimelineDates(events) {
                const datesContainer = document.getElementById('timelineDates');
                let html = '';
                
                // Calculate timeline positioning based on actual dates
                const timelineStart = new Date('2025-01-01');
                const timelineEnd = new Date('2026-12-31');
                const totalTimelineDays = (timelineEnd - timelineStart) / (1000 * 60 * 60 * 24);
                
                events.forEach((event, index) => {
                    const dateStr = event.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const isSelected = index === 0; // First event selected by default
                    
                    // Calculate position based on actual date
                    const eventDaysFromStart = (event.date - timelineStart) / (1000 * 60 * 60 * 24);
                    const positionPercentage = Math.max(5, Math.min(95, (eventDaysFromStart / totalTimelineDays) * 100));
                    
                    html += `
                        <li style="left: ${positionPercentage}%;">
                            <a href="#0" 
                               class="cd-h-timeline__date ${event.type} ${isSelected ? 'cd-h-timeline__date--selected' : ''}"
                               data-date="${event.date.toISOString()}"
                               data-event-index="${index}">
                                ${dateStr}
                            </a>
                        </li>
                    `;
                });
                
                datesContainer.innerHTML = html;
                
                // Add click handlers
                datesContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('cd-h-timeline__date')) {
                        const eventIndex = parseInt(e.target.dataset.eventIndex);
                        this.selectTimelineEvent(eventIndex);
                    }
                });
                
                // Initialize filling line
                this.updateFillingLine(0);
            }
            
            renderTimelineEvents(events) {
                const eventsContainer = document.getElementById('timelineEvents');
                let html = '';
                
                events.forEach((event, index) => {
                    const isSelected = index === 0; // First event selected by default
                    const dateStr = event.date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    html += `
                        <li class="cd-h-timeline__event ${event.type} ${isSelected ? 'cd-h-timeline__event--selected' : ''}">
                            <div class="cd-h-timeline__event-content">
                                <h2 class="cd-h-timeline__event-title">${event.title}</h2>
                                <em class="cd-h-timeline__event-date">${dateStr}</em>
                                <p class="cd-h-timeline__event-description">${event.description}</p>
                            </div>
                        </li>
                    `;
                });
                
                eventsContainer.innerHTML = html;
            }
            
            initializeTimelineNavigation(events) {
                this.timelineEvents = events;
                this.selectedEventIndex = 0;
                
                // Navigation buttons
                const prevBtn = document.querySelector('.cd-h-timeline__navigation--prev');
                const nextBtn = document.querySelector('.cd-h-timeline__navigation--next');
                
                prevBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.selectedEventIndex > 0) {
                        this.selectTimelineEvent(this.selectedEventIndex - 1);
                    }
                });
                
                nextBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (this.selectedEventIndex < events.length - 1) {
                        this.selectTimelineEvent(this.selectedEventIndex + 1);
                    }
                });
                
                this.updateNavigationButtons();
            }
            
            selectTimelineEvent(eventIndex) {
                const events = this.timelineEvents;
                if (eventIndex < 0 || eventIndex >= events.length) return;
                
                // Remove selected classes
                document.querySelectorAll('.cd-h-timeline__date--selected').forEach(el => {
                    el.classList.remove('cd-h-timeline__date--selected');
                });
                document.querySelectorAll('.cd-h-timeline__event--selected').forEach(el => {
                    el.classList.remove('cd-h-timeline__event--selected');
                });
                
                // Add selected classes
                const selectedDate = document.querySelector(`[data-event-index="${eventIndex}"]`);
                const selectedEvent = document.querySelectorAll('.cd-h-timeline__event')[eventIndex];
                
                if (selectedDate) selectedDate.classList.add('cd-h-timeline__date--selected');
                if (selectedEvent) selectedEvent.classList.add('cd-h-timeline__event--selected');
                
                // Update filling line
                this.updateFillingLine(eventIndex);
                
                this.selectedEventIndex = eventIndex;
                this.updateNavigationButtons();
            }
            
            updateFillingLine(selectedIndex) {
                const totalEvents = this.timelineEvents.length;
                const fillPercentage = totalEvents > 1 ? (selectedIndex / (totalEvents - 1)) * 100 : 0;
                
                const fillingLine = document.querySelector('.cd-h-timeline__filling-line');
                if (fillingLine) {
                    fillingLine.style.transform = `scaleX(${fillPercentage / 100})`;
                }
            }
            
            updateNavigationButtons() {
                const prevBtn = document.querySelector('.cd-h-timeline__navigation--prev');
                const nextBtn = document.querySelector('.cd-h-timeline__navigation--next');
                
                // Update prev button
                if (this.selectedEventIndex === 0) {
                    prevBtn.classList.add('cd-h-timeline__navigation--inactive');
                } else {
                    prevBtn.classList.remove('cd-h-timeline__navigation--inactive');
                }
                
                // Update next button
                if (this.selectedEventIndex === this.timelineEvents.length - 1) {
                    nextBtn.classList.add('cd-h-timeline__navigation--inactive');
                } else {
                    nextBtn.classList.remove('cd-h-timeline__navigation--inactive');
                }
            }

            renderTimeline() {
                const locations = this.dataManager.getLocations();
                const trips = this.dataManager.getTrips();
                const settings = this.dataManager.getSettings();
                const timelineContent = document.getElementById('timelineEvents');

                const events = [];

                // 1) Locations (visited only)
                locations.filter(l => l.type === 'visited').forEach(loc => {
                    const date = new Date(loc.visitDate || loc.createdAt);
                    events.push({
                        id: 'loc-' + loc.id,
                        date,
                        year: date.getFullYear(),
                        type: 'location',
                        title: loc.name,
                        subtitle: 'Visited location',
                        details: (loc.notes || '').trim(),
                    });
                });

                // 2) Trips
                trips.forEach(trip => {
                    const date = new Date(trip.startDate || trip.createdAt);
                    events.push({
                        id: 'trip-' + trip.id,
                        date,
                        year: date.getFullYear(),
                        type: 'trip',
                        title: trip.name,
                        subtitle: `${trip.cities || ''}${trip.countries ? ' � ' + trip.countries : ''}`.trim(),
                        details: `Start: ${trip.startDate ? new Date(trip.startDate).toLocaleDateString() : 'N/A'}<br>End: ${trip.endDate ? new Date(trip.endDate).toLocaleDateString() : 'N/A'}<br>${trip.notes || ''}`
                    });
                });

                // 3) First Meeting (special event)
                if (settings.firstMeetingDate) {
                    const meetingDate = new Date(settings.firstMeetingDate);
                    events.push({
                        id: 'first-meeting',
                        date: meetingDate,
                        year: meetingDate.getFullYear(),
                        type: 'special-day',
                        title: 'First Meeting',
                        subtitle: meetingDate.toLocaleDateString(),
                        details: '✨ The day we first met! The beginning of our beautiful journey together.'
                    });
                }

                // 4) Anniversaries (auto from relationship start)
                if (settings.relationshipStartDate) {
                    const start = new Date(settings.relationshipStartDate);
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const startYear = start.getFullYear();
                    
                    // Generate anniversaries for each year
                    for (let y = startYear + 1; y <= currentYear; y++) {
                        const annivDate = new Date(start);
                        annivDate.setFullYear(y);
                        const yearsTogether = y - startYear;
                        
                        // Special milestone anniversaries
                        let title, details;
                        if (yearsTogether === 1) {
                            title = "1 Year Anniversary";
                            details = "🎉 One year of love and adventures together!";
                        } else if (yearsTogether === 6) {
                            title = "6 Month Anniversary";
                            details = "💕 Six months of beautiful memories together!";
                        } else if (yearsTogether % 5 === 0) {
                            title = `${yearsTogether} Year Anniversary`;
                            details = `🌟 ${yearsTogether} years of incredible journey together!`;
                        } else {
                            title = `${yearsTogether} Year Anniversary`;
                            details = `Celebrating ${yearsTogether} years together.`;
                        }
                        
                        events.push({
                            id: `anniv-${y}`,
                            date: annivDate,
                            year: y,
                            type: 'anniversary',
                            title: title,
                            subtitle: annivDate.toLocaleDateString(),
                            details: details
                        });
                    }
                    
                    // Add monthly anniversaries for the first year
                    if (currentYear === startYear) {
                        const startMonth = start.getMonth();
                        const currentMonth = now.getMonth();
                        const currentDate = now.getDate();
                        
                        for (let m = 1; m <= Math.min(currentMonth - startMonth + (currentDate >= start.getDate() ? 1 : 0), 12); m++) {
                            const monthAnnivDate = new Date(start);
                            monthAnnivDate.setMonth(startMonth + m);
                            
                            if (monthAnnivDate <= now) {
                                events.push({
                                    id: `month-anniv-${startYear}-${m}`,
                                    date: monthAnnivDate,
                                    year: startYear,
                                    type: 'anniversary',
                                    title: `${m} Month Anniversary`,
                                    subtitle: monthAnnivDate.toLocaleDateString(),
                                    details: `💖 ${m} months of wonderful moments together!`
                                });
                            }
                        }
                    }
                }

                if (events.length === 0) {
                    timelineContent.innerHTML = '<p>Welcome to your travel and relationship dashboard! Add your first location or trip to get started.</p>';
                    return;
                }

                // Sort by date desc
                events.sort((a, b) => b.date - a.date);

                // Group by year
                const byYear = events.reduce((acc, ev) => {
                    acc[ev.year] = acc[ev.year] || [];
                    acc[ev.year].push(ev);
                    return acc;
                }, {});
                const years = Object.keys(byYear).map(Number).sort((a, b) => b - a);

                // Render
                let html = '';
                const maxYearsToShow = 5;
                const yearsToShow = years.slice(0, maxYearsToShow);
                
                yearsToShow.forEach(year => {
                    const eventCount = byYear[year].length;
                    
                    html += `<div class="timeline-year-section">
                        <div class="timeline-year-header">
                            <h3 class="timeline-year-title">
                                ${year}
                                <span class="year-badge">${eventCount} events</span>
                            </h3>
                        </div>
                        <div class="timeline-events">`;

                    byYear[year].forEach(ev => {
                        const typeColor = ev.type === 'trip' ? '#3498db' : ev.type === 'anniversary' ? '#e74c3c' : '#27ae60';
                        const dateStr = ev.date.toLocaleDateString();
                        const chevron = '&#9662;';
                        html += `
                        <div class="tl-item" style="border-left: 3px solid ${typeColor}; background: #ffffff; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-radius: 6px; margin-bottom: 10px;">
                            <div class="tl-head" onclick="mapController.toggleTimelineDetails('${ev.id}')" style="cursor: pointer; display:flex; align-items:center; gap: 0.75rem; padding: 0.75rem 0.9rem;">
                                <span style="min-width: 110px; color:#7f8c8d; font-weight:600;">${dateStr}</span>
                                <span style="flex:1; color:#2c3e50;"><strong>${ev.title}</strong>${ev.subtitle ? ' � ' + ev.subtitle : ''}</span>
                                <span style="color:#7f8c8d;">${chevron}</span>
                            </div>
                            <div id="tl-details-${ev.id}" class="tl-details" style="display:none; padding: 0 0.9rem 0.9rem 0.9rem; color:#2c3e50;">
                                ${ev.details || ''}
                            </div>
                        </div>`;
                    });
                });

                document.getElementById("timelineEvents").innerHTML = html;
                this.updateYearNavigation();
                this.setupTimelineFilters();
            }

            updateYearNavigation() {
                const years = Array.from(new Set(Array.from(document.querySelectorAll(".tl-item")).map(el => {
                    const yearText = el.querySelector(".tl-head span:first-child").textContent;
                    return new Date(yearText).getFullYear();
                }))).sort((a, b) => b - a);
                const nav = document.getElementById("timelineYearNav");
                nav.innerHTML = years.map(year => `<button class="year-btn" onclick="mapController.filterByYear(${year})">${year}</button>`).join("");
            }

            setupTimelineFilters() {
                document.getElementById("timelineTypeFilter").addEventListener("change", () => this.applyTimelineFilters());
                document.getElementById("timelineSearch").addEventListener("input", () => this.applyTimelineFilters());
            }

            clearTimelineFilters() {
                document.getElementById("timelineTypeFilter").value = "all";
                document.getElementById("timelineSearch").value = "";
                this.applyTimelineFilters();
            }

            filterByYear(year) {
                document.querySelectorAll(".year-btn").forEach(btn => btn.classList.remove("active"));
                event.target.classList.add("active");
                const items = document.querySelectorAll(".tl-item");
                items.forEach(item => {
                    const itemYear = new Date(item.querySelector(".tl-head span:first-child").textContent).getFullYear();
                    item.style.display = itemYear === year ? "block" : "none";
                });
            }

            applyTimelineFilters() {
                const typeFilter = document.getElementById("timelineTypeFilter").value;
                const searchTerm = document.getElementById("timelineSearch").value.toLowerCase();
                const items = document.querySelectorAll(".tl-item");
                items.forEach(item => {
                    const title = item.querySelector(".tl-head span:nth-child(2)").textContent.toLowerCase();
                    const type = item.classList.contains("anniversary") ? "anniversary" : item.classList.contains("trip") ? "trip" : "location";
                    const matchesType = typeFilter === "all" || type === typeFilter;
                    const matchesSearch = searchTerm === "" || title.includes(searchTerm);
                    item.style.display = matchesType && matchesSearch ? "block" : "none";
                });
            }

            loadMoreYears() {
                // This will be implemented to load additional years when needed
                // For now, just re-render the timeline to show all years
                this.renderTimeline();
            }

            setupCityAutocomplete() {
                const cityInputs = ['christineStartCity', 'philippStartCity', 'toCity'];
                
                cityInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    const resultsDiv = document.getElementById(inputId + 'Results');
                    
                    if (input && resultsDiv) {
                        let timeout;
                        
                        input.addEventListener('input', (e) => {
                            const query = e.target.value.trim();
                            
                            clearTimeout(timeout);
                            
                            if (query.length < 2) {
                                resultsDiv.style.display = 'none';
                                return;
                            }
                            
                            timeout = setTimeout(() => {
                                this.searchCities(query, resultsDiv, input);
                            }, 300);
                        });
                        
                        // Hide results when clicking outside
                        document.addEventListener('click', (e) => {
                            if (!input.contains(e.target) && !resultsDiv.contains(e.target)) {
                                resultsDiv.style.display = 'none';
                            }
                        });
                    }
                });
            }

            searchCities(query, resultsDiv, input) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1&featuretype=city`)
                    .then(response => response.json())
                    .then(data => {
                        resultsDiv.innerHTML = '';
                        
                        if (data.length === 0) {
                            resultsDiv.style.display = 'none';
                            return;
                        }
                        
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'search-result-item';
                            div.style.cssText = 'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; transition: background-color 0.2s;';
                            div.innerHTML = `<strong>${item.display_name.split(',')[0]}</strong><br><small style="color: #666;">${item.display_name}</small>`;
                            
                            div.addEventListener('click', () => {
                                input.value = item.display_name;
                                resultsDiv.style.display = 'none';
                            });
                            
                            div.addEventListener('mouseenter', () => {
                                div.style.backgroundColor = '#f8f9fa';
                            });
                            
                            div.addEventListener('mouseleave', () => {
                                div.style.backgroundColor = 'white';
                            });
                            
                            resultsDiv.appendChild(div);
                        });
                        
                        resultsDiv.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('City search error:', error);
                        resultsDiv.style.display = 'none';
                    });
            }

            updateTripsList() {
                const tripsList = document.getElementById('tripsList');
                tripsList.innerHTML = '';
                const trips = this.dataManager.getTrips();

                if (trips.length === 0) {
                    tripsList.innerHTML = '<p>No trips recorded yet. Add your first trip to get started!</p>';
                    return;
                }

                trips.forEach(trip => {
                    const tripItem = document.createElement('div');
                    tripItem.className = 'trip-item';
                    tripItem.innerHTML = `
                        <div class="trip-header">
                            <h4 class="trip-title">${trip.name}</h4>
                            <div class="trip-actions">
                                <button onclick="mapController.editTrip('${trip.id}')" class="btn btn-info btn-sm"><i class="fas fa-edit"></i></button>
                                <button onclick="mapController.deleteTrip('${trip.id}')" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="trip-details">
                            <p><strong>Start Date:</strong> ${trip.startDate ? new Date(trip.startDate).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>End Date:</strong> ${trip.endDate ? new Date(trip.endDate).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Cities:</strong> ${trip.cities || 'N/A'}</p>
                            <p><strong>Countries:</strong> ${trip.countries || 'N/A'}</p>
                        </div>
                        <div class="trip-stats">
                            <span class="trip-stat">${trip.startDate ? new Date(trip.startDate).toLocaleDateString() : 'N/A'}</span>
                            <span class="trip-stat">${trip.endDate ? new Date(trip.endDate).toLocaleDateString() : 'N/A'}</span>
                            <span class="trip-stat">${trip.cities || 'N/A'}</span>
                            <span class="trip-stat">${trip.countries || 'N/A'}</span>
                        </div>
                    `;
                    tripsList.appendChild(tripItem);
                });
            }

            editTrip(tripId) {
                const trip = this.dataManager.getTrip(tripId);
                if (trip) {
                    document.getElementById('tripName').value = trip.name;
                    document.getElementById('tripStartDate').value = trip.startDate;
                    document.getElementById('tripEndDate').value = trip.endDate;
                    document.getElementById('tripCities').value = trip.cities;
                    document.getElementById('tripCountries').value = trip.countries;
                    document.getElementById('tripNotes').value = trip.notes;
                    
                    document.getElementById('addTripModal').classList.add('show');
                    document.getElementById('tripForm').dataset.editingId = tripId;
                }
            }

            deleteTrip(tripId) {
                if (confirm('Are you sure you want to delete this trip?')) {
                    this.dataManager.deleteTrip(tripId);
                    
                    // No map elements to remove for trips, as they are just records
                    
                    this.updateStatistics().then(() => {
                        this.updateTripsList();
                    });
                }
            }

            handleAddTrip() {
                const tripData = {
                    name: document.getElementById('tripName').value,
                    startDate: document.getElementById('tripStartDate').value,
                    endDate: document.getElementById('tripEndDate').value,
                    cities: document.getElementById('tripCities').value,
                    countries: document.getElementById('tripCountries').value,
                    notes: document.getElementById('tripNotes').value
                };

                const newTrip = this.dataManager.addTrip(tripData);
                this.updateTripsList();
                this.updateTimeline();

                document.getElementById('tripForm').reset();
                document.getElementById('addTripModal').classList.remove('show');
            }
        }

        // App Controller
        class App {
            constructor(dataManagerInstance) {
                this.dataManager = dataManagerInstance || new DataManager();
                this.mapController = null;
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadInitialData();
            }

            setupEventListeners() {
                document.getElementById("settingsBtn").addEventListener("click", () => {
                    this.showSettingsModal();
                });

                document.getElementById("exportBtn").addEventListener("click", () => {
                    this.exportData();
                });

                document.getElementById("testDateBtn").addEventListener("click", () => {
                    this.testDateCalculation();
                });
            }

            async loadInitialData() {
                const stats = await this.dataManager.getStatistics();
                this.updateStatisticsDisplay(stats);
            }

            updateStatisticsDisplay(stats) {
                // Update relationship statistics dynamically
                document.getElementById("yearsTogether").textContent = formatNumber(stats.relationship.yearsTogether);
                document.getElementById("monthsTogether").textContent = formatNumber(stats.relationship.monthsTogether);
                document.getElementById("daysTogether").textContent = formatNumber(stats.relationship.daysTogether);
                
                // Update other statistics normally
                document.getElementById("citiesVisited").textContent = formatNumber(stats.travel.citiesVisited);
                document.getElementById("countriesVisited").textContent = formatNumber(stats.travel.countriesVisited);
                document.getElementById("tripsCompleted").textContent = formatNumber(stats.travel.tripsCompleted);
                document.getElementById("totalRoutes").textContent = formatNumber(stats.routes.totalRoutes);
                document.getElementById("totalDistance").textContent = formatNumber(stats.routes.totalDistance);
                
                // Update individual route statistics
                document.getElementById('christineRoutes').textContent = formatNumber(stats.routes.christine.routes);
                document.getElementById('christineDistance').textContent = formatNumber(stats.routes.christine.distance);
                document.getElementById('philippRoutes').textContent = formatNumber(stats.routes.philipp.routes);
                document.getElementById('philippDistance').textContent = formatNumber(stats.routes.philipp.distance);
                
                // Update event statistics
                if (document.getElementById('customEvents')) {
                    document.getElementById('customEvents').textContent = formatNumber(stats.events.customEvents);
                }
                if (document.getElementById('totalEvents')) {
                    document.getElementById('totalEvents').textContent = formatNumber(stats.events.totalEvents);
                }
            }

            showSettingsModal() {
                if (!document.getElementById("settingsModal")) {
                    this.createSettingsModal();
                }
                
                // Populate modal with current settings
                const settings = this.dataManager.getSettings();
                document.getElementById("firstMeetingDate").value = settings.firstMeetingDate || '';
                document.getElementById("relationshipStartDate").value = settings.relationshipStartDate || '';
                document.getElementById("countriesGoal").value = settings.countriesGoal || 50;
                
                document.getElementById("settingsModal").classList.add("show");
            }

            createSettingsModal() {
                const modalHTML = "<div id='settingsModal' class='modal'><div class='modal-content'><div class='modal-header'><h2>Settings</h2><button class='modal-close'>&times;</button></div><div class='modal-body'><form id='settingsForm'><div class='form-group'><label for='firstMeetingDate'>First Meeting Date</label><input type='date' id='firstMeetingDate'></div><div class='form-group'><label for='relationshipStartDate'>Relationship Start Date</label><input type='date' id='relationshipStartDate'></div><div class='form-group'><label for='countriesGoal'>Countries Goal</label><input type='number' id='countriesGoal' min='1' value='50'></div><div class='form-actions'><button type='button' class='btn btn-secondary modal-close'>Cancel</button><button type='submit' class='btn btn-primary'>Save Settings</button></div></form></div></div></div>";
                document.body.insertAdjacentHTML("beforeend", modalHTML);
                
                document.getElementById("settingsForm").addEventListener("submit", (e) => {
                    e.preventDefault();
                    this.saveSettings();
                });
            }

            saveSettings() {
                const settings = {
                    firstMeetingDate: document.getElementById("firstMeetingDate").value,
                    relationshipStartDate: document.getElementById("relationshipStartDate").value,
                    countriesGoal: parseInt(document.getElementById("countriesGoal").value)
                };
                
                this.dataManager.updateSettings(settings);
                this.dataManager.getStatistics().then(stats => {
                    this.updateStatisticsDisplay(stats);
                });
                document.getElementById("settingsModal").classList.remove("show");
            }

            exportData() {
                const data = this.dataManager.exportData();
                const blob = new Blob([data], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "travel-relationship-data.json";
                a.click();
                URL.revokeObjectURL(url);
            }

            async testDateCalculation() {
                console.log('🧪 Manual date calculation test initiated...');
                try {
                    const result = await this.dataManager.testDateCalculation();
                    alert(`Date Calculation Test Result:\n${result.years} years, ${result.months} months, ${result.days} days\n\nCheck console for detailed logs.`);
                } catch (error) {
                    console.error('❌ Date calculation test failed:', error);
                    alert('Date calculation test failed. Check console for details.');
                }
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            // Initialize data manager
            dataManager = new DataManager();
            
            // Initialize map controller with the same data manager instance
            mapController = new MapController(dataManager);
            
            // Initialize app with the same data manager instance
            new App(dataManager);
            
            console.log('App initialized successfully');
        });
    </script>
</body>
</html>





























